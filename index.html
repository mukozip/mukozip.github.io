<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Management App</title>
    <link rel="icon" type="image/png" href="/favicon.png"> <!-- Updated to .png -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"] {
            width: 60px;
            padding: 4px;
        }
        input[type="text"], input[type="date"] {
            padding: 4px;
            margin: 5px;
            width: 150px;
        }
        button {
            padding: 8px 16px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .form-container {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
        .message {
            color: green;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Dairy Management App</h1>
    <p>Enter cow details (number and name) to track daily AM (Morning Milk) and PM (Evening Milk) production. After adding a cow, input milk values for each session. The app calculates totals and lactation periods based on the current date (August 14, 2025). Data is saved locally and persists across page refreshes.</p>
    
    <div class="form-container">
        <label for="cowNo">Cow No:</label>
        <input type="text" id="cowNo" required placeholder="e.g., 297">
        
        <label for="cowName">Cow Name:</label>
        <input type="text" id="cowName" required placeholder="e.g., Mercy">
        
        <label for="calvingDate">Last Calving Date:</label>
        <input type="date" id="calvingDate" required>
        
        <label for="monthsPreg">Months of Pregnancy:</label>
        <input type="number" id="monthsPreg" step="0.1" min="0" placeholder="e.g., 3.4">
        
        <button type="button" onclick="addCowFromForm()">Add Cow</button>
    </div>
    <div id="message" class="message"></div>
    
    <table id="milkTable">
        <thead>
            <tr>
                <th>COW NO./NAME</th>
                <th>TIME</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
                <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th>
                <th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th>
                <th>TOTAL DAILY PRODUCTION</th>
                <th>TOTAL MONTHLY PRODUCTION</th>
                <th>LAST CALVING DATE</th>
                <th>DAYS OF PDN SINCE CALVING</th>
                <th>MONTHS OF PREG</th>
            </tr>
        </thead>
        <tbody>
            <!-- Cows will be added here -->
        </tbody>
        <tfoot>
            <tr id="footerRowAM">
                <td></td>
                <td>AM</td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr id="footerRowPM">
                <td></td>
                <td>PM</td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <script>
        const today = new Date(2025, 7, 14); // August 14, 2025 (month is 0-based)
        let cowCount = 0;

        // Excel data with each cow having both AM and PM values
        const cowDataFromExcel = [
            { cowNo: "297", displayName: "1. MERCY", calvingDateStr: "2024-03-01", monthsPreg: "4.66666666666667", 
              amValues: ["4.5", "4.5", "4.5", "4.5", "5", "", "4.5", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "413", displayName: "2. MAGRET", calvingDateStr: "2024-03-04", monthsPreg: "3.4", 
              amValues: ["5", "5", "5.5", "5", "5.5", "", "6.5", "5.5", "5", "5", "5.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "3", "2.5", "2", "2", "2", "2.5", "2.5", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "427", displayName: "3. CECE", calvingDateStr: "2024-05-15", monthsPreg: "3.2", 
              amValues: ["3.5", "3", "4", "3", "3.5", "", "3.5", "3.5", "3.5", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "2", "2", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "425", displayName: "4. ANGEL", calvingDateStr: "2024-05-19", monthsPreg: "5.36666666666667", 
              amValues: ["3.5", "4", "4", "4", "4", "", "4", "4", "4", "3.5", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2", "2", "2", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "093", displayName: "5. RITAH", calvingDateStr: "2024-05-28", monthsPreg: "", 
              amValues: ["4.5", "5", "4", "4.5", "4.5", "", "4.5", "5.5", "5", "5.5", "4.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3", "3", "3", "2.5", "3", "3", "3", "3", "3", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "059", displayName: "6. SUSAN", calvingDateStr: "2024-07-24", monthsPreg: "2.1", 
              amValues: ["6", "5.5", "4.5", "5", "4.5", "", "4", "4", "3.5", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2", "2", "3", "2", "2", "2", "2", "3", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "008", displayName: "7. FRIDA", calvingDateStr: "2024-07-26", monthsPreg: "3.46666666666667", 
              amValues: ["3.5", "3", "3", "3", "3.5", "", "3", "3.5", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { cowNo: "434", displayName: "8. SHANA", calvingDateStr: "2024-10-06", monthsPreg: "1.56666666666667", 
              amValues: ["4.5", "4.5", "4", "4", "4", "", "4", "3.5", "4", "3.5", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "2", "2.5", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "083", displayName: "9. KATHY", calvingDateStr: "2024-10-27", monthsPreg: "", 
              amValues: ["4.5", "4", "4", "4", "4", "", "2.5", "4", "2.5", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { cowNo: "402", displayName: "10. KELLEN", calvingDateStr: "2024-11-13", monthsPreg: "", 
              amValues: ["7", "6.5", "7", "5", "5", "", "6", "6", "6", "6", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "4.5", "3", "2", "3.5", "4", "3", "2", "2", "2.5", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "098", displayName: "11. JACKLINE", calvingDateStr: "2024-11-28", monthsPreg: "", 
              amValues: ["3", "3", "3", "2.5", "3.5", "", "3", "3", "2.5", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "421", displayName: "12. EVA", calvingDateStr: "2024-11-28", monthsPreg: "", 
              amValues: ["7", "7", "7", "7", "7.5", "", "6.5", "7", "7", "7", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "5", "3.5", "4", "4", "4", "4", "3.5", "3", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "099", displayName: "13. SARAH", calvingDateStr: "2024-12-04", monthsPreg: "", 
              amValues: ["4", "4", "4", "4", "4", "", "4", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "521", displayName: "14. KEZA", calvingDateStr: "2024-12-09", monthsPreg: "", 
              amValues: ["4", "4", "4", "4", "3", "", "3", "4", "3", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "1.5", "1.5", "1.5", "2", "2", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "024", displayName: "15. KIRABO", calvingDateStr: "2024-12-11", monthsPreg: "", 
              amValues: ["5", "4.5", "4.5", "5.5", "4.5", "", "4", "5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "403", displayName: "16. PEACE", calvingDateStr: "2024-12-26", monthsPreg: "", 
              amValues: ["7.5", "7", "7", "7", "6", "", "7", "8", "7", "7", "7", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "4.5", "4.5", "4.5", "4", "3.5", "3.5", "3.5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "418", displayName: "17. IRENE", calvingDateStr: "2025-01-02", monthsPreg: "", 
              amValues: ["7", "6.5", "7", "6.5", "7", "", "7.5", "7", "7", "6.5", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "3", "3", "3", "3.5", "3", "3.5", "3", "3", "3", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "296", displayName: "18. JOAN", calvingDateStr: "2025-01-13", monthsPreg: "", 
              amValues: ["8", "7", "7", "6.5", "6.5", "", "8", "6", "6.5", "5.5", "6", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["5", "4", "4", "3.5", "4", "4", "4", "3", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "511", displayName: "19. SIIMA", calvingDateStr: "2025-01-02", monthsPreg: "", 
              amValues: ["5", "5.5", "6", "6", "5", "", "5.5", "5.5", "6", "5.5", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "3", "4", "4", "3", "3.5", "3", "3.5", "4", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { cowNo: "021", displayName: "20. BIRA", calvingDateStr: "2025-01-02", monthsPreg: "", 
              amValues: ["2", "2", "2", "1", "1", "", "3", "4", "4", "3", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "1", "1.5", "1.5", "1.5", "1.5", "2", "1.5", "1", "1", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] }
        ];

        // Validate and initialize cows array
        let cows = [];
        try {
            const storedCows = JSON.parse(localStorage.getItem('cows'));
            if (Array.isArray(storedCows) && storedCows.every(cow => cow.displayName && typeof cow.displayName === 'string' && cow.cowNo && cow.amValues && cow.pmValues)) {
                cows = storedCows;
                console.log('Loaded valid cows from localStorage:', cows.length);
            } else {
                throw new Error('Invalid localStorage data');
            }
        } catch (e) {
            console.log('Invalid or empty localStorage, using cowDataFromExcel:', e.message);
            cows = cowDataFromExcel;
            localStorage.setItem('cows', JSON.stringify(cows));
        }

        // Load existing cows on page load
        window.onload = function() {
            console.log('Page loaded, cows:', cows);
            if (cows.length > 0) {
                cowCount = Math.max(...cows.map(cow => {
                    if (cow.displayName && typeof cow.displayName === 'string') {
                        const match = cow.displayName.match(/^(\d+)\./);
                        return match ? parseInt(match[1]) : 0;
                    }
                    console.warn(`Skipping invalid cow: ${JSON.stringify(cow)}`);
                    return 0;
                }), 0);
                console.log('cowCount set to:', cowCount);
                cows.forEach((cow, index) => {
                    if (cow.displayName && cow.cowNo) {
                        console.log(`Adding cow ${index + 1}: ${cow.displayName}`);
                        addCowToTable(cow);
                    } else {
                        console.warn(`Skipping cow with missing data: ${JSON.stringify(cow)}`);
                    }
                });
                recalculate();
            } else {
                console.log('No valid cows found in localStorage or cowDataFromExcel');
            }
        };

        function addCowFromForm() {
            const cowNo = document.getElementById('cowNo').value.trim();
            const cowName = document.getElementById('cowName').value.trim();
            const calvingDateStr = document.getElementById('calvingDate').value;
            const monthsPreg = document.getElementById('monthsPreg').value || '';

            if (!cowNo || !cowName || !calvingDateStr) {
                alert('Please fill in all required fields (Cow No, Cow Name, Last Calving Date).');
                return;
            }

            cowCount++;
            const displayName = `${cowCount}. ${cowName}`;
            const cowData = {
                cowNo,
                displayName,
                calvingDateStr,
                monthsPreg,
                amValues: Array(31).fill(''),
                pmValues: Array(31).fill('')
            };

            cows.push(cowData);
            localStorage.setItem('cows', JSON.stringify(cows));

            console.log(`Adding new cow from form: ${displayName}`);
            addCowToTable(cowData);

            // Clear form inputs
            document.getElementById('cowNo').value = '';
            document.getElementById('cowName').value = '';
            document.getElementById('calvingDate').value = '';
            document.getElementById('monthsPreg').value = '';

            document.getElementById('message').textContent = `Cow ${displayName} added successfully!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);

            recalculate();
        }

        function addCowToTable(cowData) {
            const { cowNo = '', displayName = '', calvingDateStr = '', monthsPreg = '', amValues = Array(31).fill(''), pmValues = Array(31).fill('') } = cowData;
            const calving = calvingDateStr ? new Date(calvingDateStr) : null;
            const daysSince = calving ? Math.floor((today - calving) / (1000 * 60 * 60 * 24)) : '';

            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];

            // AM Row (Morning Milk)
            const amRow = tableBody.insertRow();
            amRow.insertCell().textContent = cowNo;
            amRow.insertCell().textContent = 'AM';
            for (let d = 0; d < 31; d++) {
                const cell = amRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = amValues[d] || '';
                input.addEventListener('input', () => {
                    cowData.amValues[d] = input.value;
                    localStorage.setItem('cows', JSON.stringify(cows));
                    recalculate();
                });
                cell.appendChild(input);
            }
            const totalDailyAMCell = amRow.insertCell();
            amRow.insertCell(); // TOTAL MONTHLY PRODUCTION (empty for AM)
            amRow.insertCell(); // LAST CALVING DATE (empty for AM)
            amRow.insertCell(); // DAYS SINCE (empty for AM)
            amRow.insertCell(); // MONTHS PREG (empty for AM)

            // PM Row (Evening Milk)
            const pmRow = tableBody.insertRow();
            pmRow.insertCell().textContent = displayName;
            pmRow.insertCell().textContent = 'PM';
            for (let d = 0; d < 31; d++) {
                const cell = pmRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = pmValues[d] || '';
                input.addEventListener('input', () => {
                    cowData.pmValues[d] = input.value;
                    localStorage.setItem('cows', JSON.stringify(cows));
                    recalculate();
                });
                cell.appendChild(input);
            }
            const totalDailyPMCell = pmRow.insertCell();
            const totalMonthlyCell = pmRow.insertCell();
            pmRow.insertCell().textContent = calvingDateStr;
            pmRow.insertCell().textContent = daysSince;
            pmRow.insertCell().textContent = monthsPreg;

            console.log(`Added rows for ${displayName || 'undefined'}: AM=${amValues.slice(0, 5)}, PM=${pmValues.slice(0, 5)}`);
        }

        function recalculate() {
            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const footerRowAM = document.getElementById('footerRowAM');
            const footerRowPM = document.getElementById('footerRowPM');
            const amSums = Array(31).fill(0);
            const pmSums = Array(31).fill(0);
            let totalAMAll = 0;
            let totalPMAll = 0;

            for (let i = 0; i < tableBody.rows.length; i += 2) {
                const amRow = tableBody.rows[i];
                const pmRow = tableBody.rows[i + 1];

                // Calculate AM totals
                let amSum = 0;
                for (let d = 0; d < 31; d++) {
                    const val = parseFloat(amRow.cells[d + 2].querySelector('input').value) || 0;
                    amSum += val;
                    amSums[d] += val;
                }
                amRow.cells[33].textContent = amSum.toFixed(1); // TOTAL DAILY PRODUCTION for AM

                // Calculate PM totals
                let pmSum = 0;
                for (let d = 0; d < 31; d++) {
                    const val = parseFloat(pmRow.cells[d + 2].querySelector('input').value) || 0;
                    pmSum += val;
                    pmSums[d] += val;
                }
                pmRow.cells[33].textContent = pmSum.toFixed(1); // TOTAL DAILY PRODUCTION for PM
                pmRow.cells[34].textContent = (amSum + pmSum).toFixed(1); // TOTAL MONTHLY PRODUCTION

                totalAMAll += amSum;
                totalPMAll += pmSum;
            }

            // Update footer sums for AM
            for (let d = 0; d < 31; d++) {
                footerRowAM.cells[d + 2].textContent = amSums[d].toFixed(1);
            }
            footerRowAM.cells[34].textContent = totalAMAll.toFixed(1); // Total AM across all cows

            // Update footer sums for PM
            for (let d = 0; d < 31; d++) {
                footerRowPM.cells[d + 2].textContent = pmSums[d].toFixed(1);
            }
            footerRowPM.cells[34].textContent = totalPMAll.toFixed(1); // Total PM across all cows

            console.log(`Recalculated: AM Total=${totalAMAll.toFixed(1)}, PM Total=${totalPMAll.toFixed(1)}`);
        }
    </script>
</body>
</html>
