<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Management App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"] {
            width: 60px;
            padding: 4px;
        }
        input[type="text"], input[type="date"], select {
            padding: 4px;
            margin: 5px;
            width: 150px;
        }
        button {
            padding: 8px 16px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .form-container {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
        .message {
            color: green;
            margin: 10px 0;
        }
        .ranking-section {
            margin-top: 30px;
        }
        .ranking-table {
            width: 50%;
            margin-bottom: 20px;
        }
        .ranking-table th {
            background-color: #e0e0e0;
        }
        .date-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Dairy Management App</h1>
    <p>Enter cow details (number and name) to track daily AM (Morning Milk) and PM (Evening Milk) production. After adding a cow, input milk values for each session. The app calculates totals, deductions, and lactation periods based on the current date (August 14, 2025). Data is saved locally and persists across page refreshes. Export to CSV for Excel use.</p>
    
    <div class="form-container">
        <label for="cowNo">Cow No:</label>
        <input type="text" id="cowNo" required placeholder="e.g., 297">
        
        <label for="cowName">Cow Name:</label>
        <input type="text" id="cowName" required placeholder="e.g., Mercy">
        
        <label for="calvingDate">Last Calving Date:</label>
        <input type="date" id="calvingDate" required>
        
        <label for="monthsPreg">Months of Pregnancy:</label>
        <input type="number" id="monthsPreg" step="0.1" min="0" placeholder="e.g., 3.4">
        
        <button type="button" onclick="addCowFromForm()">Add Cow</button>
    </div>
    <div id="message" class="message"></div>
    
    <label for="monthSelect">Month:</label>
    <select id="monthSelect" onchange="changeMonth(this.value)">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
    </select>
    <button onclick="saveCurrentMonth()">Save</button>
    <button onclick="exportToCSV()">Export to CSV</button>
    
    <table id="milkTable">
        <caption id="tableCaption">July Records</caption>
        <thead>
            <tr>
                <th>COW NO./NAME</th>
                <th>TIME</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
                <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th>
                <th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th>
                <th>TOTAL DAILY PRODUCTION</th>
                <th>TOTAL MONTHLY PRODUCTION</th>
                <th>LAST CALVING DATE</th>
                <th>DAYS OF PDN SINCE CALVING</th>
                <th>MONTHS OF PREG</th>
            </tr>
        </thead>
        <tbody>
            <!-- Cows will be added here -->
        </tbody>
        <tfoot>
            <tr id="footerRowAM">
                <td></td>
                <td>AM</td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr id="footerRowPM">
                <td></td>
                <td>PM</td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <!-- Deductions rows will be added here -->
        </tfoot>
    </table>

    <div class="ranking-section">
        <h2>Daily Milk Producers by Date</h2>
        <div class="date-selector">
            <label for="dateSelect">Select Date:</label>
            <select id="dateSelect" onchange="updateDailyRankings(this.value)">
                <!-- Dates will be populated dynamically -->
            </select>
        </div>
        <table class="ranking-table" id="topDailyTable">
            <caption id="topDailyCaption">Top 5 Daily Milk Producers</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total Milk (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="worstDailyTable">
            <caption id="worstDailyCaption">Worst 5 Daily Milk Producers</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total Milk (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const today = new Date(2025, 7, 14); // August 14, 2025 (month is 0-based)
        let cowCount = 0;
        let currentMonth = 'July';
        let selectedDate = '1'; // Default to day 1

        // Fixed cow data from Excel (without production)
        const fixedCowsFromExcel = [
            { cowNo: "297", displayName: "1. MERCY", calvingDateStr: "2024-03-01", monthsPreg: "4.66666666666667" },
            { cowNo: "413", displayName: "2. MAGRET", calvingDateStr: "2024-03-04", monthsPreg: "3.4" },
            { cowNo: "427", displayName: "3. CECE", calvingDateStr: "2024-05-15", monthsPreg: "3.2" },
            { cowNo: "425", displayName: "4. ANGEL", calvingDateStr: "2024-05-19", monthsPreg: "5.36666666666667" },
            { cowNo: "093", displayName: "5. RITAH", calvingDateStr: "2024-05-28", monthsPreg: "" },
            { cowNo: "059", displayName: "6. SUSAN", calvingDateStr: "2024-07-24", monthsPreg: "2.1" },
            { cowNo: "008", displayName: "7. FRIDA", calvingDateStr: "2024-07-26", monthsPreg: "3.46666666666667" },
            { cowNo: "434", displayName: "8. SHANA", calvingDateStr: "2024-10-06", monthsPreg: "1.56666666666667" },
            { cowNo: "083", displayName: "9. KATHY", calvingDateStr: "2024-10-27", monthsPreg: "" },
            { cowNo: "402", displayName: "10. KELLEN", calvingDateStr: "2024-11-13", monthsPreg: "" },
            { cowNo: "098", displayName: "11. JACKLINE", calvingDateStr: "2024-11-28", monthsPreg: "" },
            { cowNo: "421", displayName: "12. EVA", calvingDateStr: "2024-11-28", monthsPreg: "" },
            { cowNo: "099", displayName: "13. SARAH", calvingDateStr: "2024-12-04", monthsPreg: "" },
            { cowNo: "521", displayName: "14. KEZA", calvingDateStr: "2024-12-09", monthsPreg: "" },
            { cowNo: "024", displayName: "15. KIRABO", calvingDateStr: "2024-12-11", monthsPreg: "" },
            { cowNo: "403", displayName: "16. PEACE", calvingDateStr: "2024-12-26", monthsPreg: "" },
            { cowNo: "418", displayName: "17. IRENE", calvingDateStr: "2025-01-02", monthsPreg: "" },
            { cowNo: "296", displayName: "18. JOAN", calvingDateStr: "2025-01-13", monthsPreg: "" },
            { cowNo: "511", displayName: "19. SIIMA", calvingDateStr: "2025-01-02", monthsPreg: "" },
            { cowNo: "021", displayName: "20. BIRA", calvingDateStr: "2025-01-02", monthsPreg: "" }
        ];

        // Initial production for July from Excel
        const initialJulyProductions = [
            { amValues: ["4.5", "4.5", "4.5", "4.5", "5", "", "4.5", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "5", "5.5", "5", "5.5", "", "6.5", "5.5", "5", "5", "5.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "3", "2.5", "2", "2", "2", "2.5", "2.5", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "3", "4", "3", "3.5", "", "3.5", "3.5", "3.5", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "2", "2", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "4", "4", "4", "4", "", "4", "4", "4", "3.5", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2", "2", "2", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4.5", "5", "4", "4.5", "4.5", "", "4.5", "5.5", "5", "5.5", "4.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3", "3", "3", "2.5", "3", "3", "3", "3", "3", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["6", "5.5", "4.5", "5", "4.5", "", "4", "4", "3.5", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2", "2", "3", "2", "2", "2", "2", "3", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "3", "3", "3", "3.5", "", "3", "3.5", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { amValues: ["4.5", "4.5", "4", "4", "4", "", "4", "3.5", "4", "3.5", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "2", "2.5", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4.5", "4", "4", "4", "4", "", "2.5", "4", "2.5", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { amValues: ["7", "6.5", "7", "5", "5", "", "6", "6", "6", "6", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "4.5", "3", "2", "3.5", "4", "3", "2", "2", "2.5", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3", "3", "3", "2.5", "3.5", "", "3", "3", "2.5", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7", "7", "7", "7", "7.5", "", "6.5", "7", "7", "7", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "5", "3.5", "4", "4", "4", "4", "3.5", "3", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4", "4", "4", "4", "4", "", "4", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4", "4", "4", "4", "3", "", "3", "4", "3", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "1.5", "1.5", "1.5", "2", "2", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "4.5", "4.5", "5.5", "4.5", "", "4", "5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7.5", "7", "7", "7", "6", "", "7", "8", "7", "7", "7", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "4.5", "4.5", "4.5", "4", "3.5", "3.5", "3.5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7", "6.5", "7", "6.5", "7", "", "7.5", "7", "7", "6.5", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "3", "3", "3", "3.5", "3", "3.5", "3", "3", "3", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["8", "7", "7", "6.5", "6.5", "", "8", "6", "6.5", "5.5", "6", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["5", "4", "4", "3.5", "4", "4", "4", "3", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "5.5", "6", "6", "5", "", "5.5", "5.5", "6", "5.5", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "3", "4", "4", "3", "3.5", "3", "3.5", "4", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["2", "2", "2", "1", "1", "", "3", "4", "4", "3", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "1", "1.5", "1.5", "1.5", "1.5", "2", "1.5", "1", "1", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] }
        ];

        let fixedCows = JSON.parse(localStorage.getItem('fixedCows')) || fixedCowsFromExcel;
        let productionData = JSON.parse(localStorage.getItem('productionData')) || {};
        cowCount = fixedCows.length; // Initialize cowCount based on fixedCows

        if (!productionData['July']) {
            productionData['July'] = {
                productions: initialJulyProductions,
                deductions: {
                    homeUse: Array(31).fill(''),
                    workersMilk: Array(31).fill(''),
                    calvesMilk: Array(31).fill('')
                }
            };
        }

        // Ensure productionData for each month has enough production arrays
        Object.keys(productionData).forEach(month => {
            while (productionData[month].productions.length < fixedCows.length) {
                productionData[month].productions.push({ amValues: Array(31).fill(''), pmValues: Array(31).fill('') });
            }
        });

        localStorage.setItem('fixedCows', JSON.stringify(fixedCows));
        localStorage.setItem('productionData', JSON.stringify(productionData));

        // Load initial month
        window.onload = function() {
            document.getElementById('monthSelect').value = currentMonth;
            populateDateDropdown();
            loadMonth(currentMonth);
        };

        function populateDateDropdown() {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '';
            for (let d = 1; d <= 31; d++) {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = `${currentMonth} ${d}`;
                dateSelect.appendChild(option);
            }
            dateSelect.value = selectedDate;
        }

        function changeMonth(newMonth) {
            saveCurrentMonth();
            currentMonth = newMonth;
            selectedDate = '1'; // Reset to day 1
            populateDateDropdown();
            loadMonth(currentMonth);
        }

        function saveCurrentMonth() {
            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const productions = [];
            for (let i = 0; i < tbody.rows.length; i += 2) {
                const amRow = tbody.rows[i];
                const pmRow = tbody.rows[i + 1];
                const amValues = [];
                const pmValues = [];
                for (let d = 0; d < 31; d++) {
                    amValues[d] = amRow.cells[d + 2].querySelector('input').value;
                    pmValues[d] = pmRow.cells[d + 2].querySelector('input').value;
                }
                productions.push({amValues, pmValues});
            }
            productionData[currentMonth].productions = productions;

            const deductions = productionData[currentMonth].deductions;
            for (let d = 0; d < 31; d++) {
                deductions.homeUse[d] = document.getElementById('homeUseRow')?.cells[d + 2]?.querySelector('input')?.value || '';
                deductions.workersMilk[d] = document.getElementById('workersMilkRow')?.cells[d + 2]?.querySelector('input')?.value || '';
                deductions.calvesMilk[d] = document.getElementById('calvesMilkRow')?.cells[d + 2]?.querySelector('input')?.value || '';
            }

            localStorage.setItem('productionData', JSON.stringify(productionData));
        }

        function loadMonth(month) {
            if (!productionData[month]) {
                productionData[month] = {
                    productions: fixedCows.map(() => ({amValues: Array(31).fill(''), pmValues: Array(31).fill('')})),
                    deductions: {
                        homeUse: Array(31).fill(''),
                        workersMilk: Array(31).fill(''),
                        calvesMilk: Array(31).fill('')
                    }
                };
            }

            // Ensure productions array matches fixedCows length
            while (productionData[month].productions.length < fixedCows.length) {
                productionData[month].productions.push({ amValues: Array(31).fill(''), pmValues: Array(31).fill('') });
            }

            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            const productions = productionData[month].productions;
            fixedCows.forEach((cow, index) => {
                if (productions[index]) {
                    addCowToTable(cow, productions[index].amValues, productions[index].pmValues);
                } else {
                    console.error(`No production data for cow ${cow.displayName} at index ${index}`);
                    addCowToTable(cow, Array(31).fill(''), Array(31).fill(''));
                }
            });

            removeDeductionsRows();
            addDeductionsRows(productionData[month].deductions);
            document.getElementById('tableCaption').textContent = `${month} Records`;

            recalculate();
        }

        function removeDeductionsRows() {
            ['homeUseRow', 'workersMilkRow', 'calvesMilkRow', 'totalDeductionsRow', 'netLitersRow'].forEach(id => {
                const row = document.getElementById(id);
                if (row) row.remove();
            });
        }

        function addDeductionsRows(deductions) {
            const tfoot = document.getElementById('milkTable').getElementsByTagName('tfoot')[0];

            // Home Use Row
            const homeRow = tfoot.insertRow();
            homeRow.id = 'homeUseRow';
            const labelCellHome = homeRow.insertCell();
            labelCellHome.colSpan = 2;
            labelCellHome.textContent = 'Home Use';
            for (let d = 0; d < 31; d++) {
                const cell = homeRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.homeUse[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(); });
                cell.appendChild(input);
            }
            homeRow.insertCell(); // total
            homeRow.insertCell().colSpan = 4;

            // Workers Milk Row
            const workersRow = tfoot.insertRow();
            workersRow.id = 'workersMilkRow';
            const labelCellWorkers = workersRow.insertCell();
            labelCellWorkers.colSpan = 2;
            labelCellWorkers.textContent = 'Workers Milk';
            for (let d = 0; d < 31; d++) {
                const cell = workersRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.workersMilk[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(); });
                cell.appendChild(input);
            }
            workersRow.insertCell(); // total
            workersRow.insertCell().colSpan = 4;

            // Calves Milk Row
            const calvesRow = tfoot.insertRow();
            calvesRow.id = 'calvesMilkRow';
            const labelCellCalves = calvesRow.insertCell();
            labelCellCalves.colSpan = 2;
            labelCellCalves.textContent = 'Calves Milk';
            for (let d = 0; d < 31; d++) {
                const cell = calvesRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.calvesMilk[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(); });
                cell.appendChild(input);
            }
            calvesRow.insertCell(); // total
            calvesRow.insertCell().colSpan = 4;

            // Total Deductions Row (calculated)
            const totalDeductionsRow = tfoot.insertRow();
            totalDeductionsRow.id = 'totalDeductionsRow';
            const labelCellTotalDeductions = totalDeductionsRow.insertCell();
            labelCellTotalDeductions.colSpan = 2;
            labelCellTotalDeductions.textContent = 'Total Deductions';
            for (let d = 0; d < 31; d++) {
                totalDeductionsRow.insertCell();
            }
            totalDeductionsRow.insertCell(); // total
            totalDeductionsRow.insertCell().colSpan = 4;

            // Net Liters Row (calculated)
            const netLitersRow = tfoot.insertRow();
            netLitersRow.id = 'netLitersRow';
            const labelCellNet = netLitersRow.insertCell();
            labelCellNet.colSpan = 2;
            labelCellNet.textContent = 'Net Liters';
            for (let d = 0; d < 31; d++) {
                netLitersRow.insertCell();
            }
            netLitersRow.insertCell(); // total
            netLitersRow.insertCell().colSpan = 4;
        }

        function addCowFromForm() {
            const cowNo = document.getElementById('cowNo').value.trim();
            const cowName = document.getElementById('cowName').value.trim();
            const calvingDateStr = document.getElementById('calvingDate').value;
            const monthsPreg = document.getElementById('monthsPreg').value || '';

            if (!cowNo || !cowName || !calvingDateStr) {
                alert('Please fill in all required fields (Cow No, Cow Name, Last Calving Date).');
                return;
            }

            cowCount++;
            const displayName = `${cowCount}. ${cowName}`;
            const newCow = {
                cowNo,
                displayName,
                calvingDateStr,
                monthsPreg
            };

            fixedCows.push(newCow);
            localStorage.setItem('fixedCows', JSON.stringify(fixedCows));

            // Add new production to all months
            for (const month in productionData) {
                productionData[month].productions.push({amValues: Array(31).fill(''), pmValues: Array(31).fill('')});
            }
            localStorage.setItem('productionData', JSON.stringify(productionData));

            // Reload current month to add the new cow
            loadMonth(currentMonth);

            // Clear form inputs
            document.getElementById('cowNo').value = '';
            document.getElementById('cowName').value = '';
            document.getElementById('calvingDate').value = '';
            document.getElementById('monthsPreg').value = '';

            document.getElementById('message').textContent = `Cow ${displayName} added successfully!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function addCowToTable(cow, amValues, pmValues) {
            const { cowNo = '', displayName = '', calvingDateStr = '', monthsPreg = '' } = cow;
            const calving = calvingDateStr ? new Date(calvingDateStr) : null;
            const daysSince = calving ? Math.floor((today - calving) / (1000 * 60 * 60 * 24)) : '';

            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];

            // AM Row (Morning Milk)
            const amRow = tableBody.insertRow();
            amRow.insertCell().textContent = cowNo;
            amRow.insertCell().textContent = 'AM';
            for (let d = 0; d < 31; d++) {
                const cell = amRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = amValues[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(); });
                cell.appendChild(input);
            }
            const totalDailyAMCell = amRow.insertCell();
            amRow.insertCell(); // TOTAL MONTHLY PRODUCTION (empty for AM)
            amRow.insertCell(); // LAST CALVING DATE (empty for AM)
            amRow.insertCell(); // DAYS SINCE (empty for AM)
            amRow.insertCell(); // MONTHS PREG (empty for AM)

            // PM Row (Evening Milk)
            const pmRow = tableBody.insertRow();
            pmRow.insertCell().textContent = displayName;
            pmRow.insertCell().textContent = 'PM';
            for (let d = 0; d < 31; d++) {
                const cell = pmRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = pmValues[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(); });
                cell.appendChild(input);
            }
            const totalDailyPMCell = pmRow.insertCell();
            const totalMonthlyCell = pmRow.insertCell();
            pmRow.insertCell().textContent = calvingDateStr;
            pmRow.insertCell().textContent = daysSince;
            pmRow.insertCell().textContent = monthsPreg;
        }

        function recalculate() {
            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const footerRowAM = document.getElementById('footerRowAM');
            const footerRowPM = document.getElementById('footerRowPM');
            const homeRow = document.getElementById('homeUseRow');
            const workersRow = document.getElementById('workersMilkRow');
            const calvesRow = document.getElementById('calvesMilkRow');
            const totalDeductionsRow = document.getElementById('totalDeductionsRow');
            const netLitersRow = document.getElementById('netLitersRow');

            if (!homeRow || !workersRow || !calvesRow || !totalDeductionsRow || !netLitersRow) {
                console.error('Deductions rows not found, skipping deductions calculation');
                return;
            }

            const amSums = Array(31).fill(0);
            const pmSums = Array(31).fill(0);
            let totalAMAll = 0;
            let totalPMAll = 0;

            // Calculate cow totals
            for (let i = 0; i < tableBody.rows.length; i += 2) {
                const amRow = tableBody.rows[i];
                const pmRow = tableBody.rows[i + 1];

                // Calculate AM totals
                let amSum = 0;
                for (let d = 0; d < 31; d++) {
                    const val = parseFloat(amRow.cells[d + 2].querySelector('input').value) || 0;
                    amSum += val;
                    amSums[d] += val;
                }
                amRow.cells[33].textContent = amSum.toFixed(1); // TOTAL DAILY PRODUCTION for AM

                // Calculate PM totals
                let pmSum = 0;
                for (let d = 0; d < 31; d++) {
                    const val = parseFloat(pmRow.cells[d + 2].querySelector('input').value) || 0;
                    pmSum += val;
                    pmSums[d] += val;
                }
                pmRow.cells[33].textContent = pmSum.toFixed(1); // TOTAL DAILY PRODUCTION for PM
                pmRow.cells[34].textContent = (amSum + pmSum).toFixed(1); // TOTAL MONTHLY PRODUCTION

                totalAMAll += amSum;
                totalPMAll += pmSum;
            }

            // Update footer sums for AM
            for (let d = 0; d < 31; d++) {
                footerRowAM.cells[d + 2].textContent = amSums[d].toFixed(1);
            }
            footerRowAM.cells[34].textContent = totalAMAll.toFixed(1); // Total AM across all cows

            // Update footer sums for PM
            for (let d = 0; d < 31; d++) {
                footerRowPM.cells[d + 2].textContent = pmSums[d].toFixed(1);
            }
            footerRowPM.cells[34].textContent = totalPMAll.toFixed(1); // Total PM across all cows

            // Calculate deductions and net
            let homeSum = 0;
            let workersSum = 0;
            let calvesSum = 0;
            const deductionsPerDay = Array(31).fill(0);
            let totalDeductions = 0;
            for (let d = 0; d < 31; d++) {
                const home = parseFloat(homeRow.cells[d + 2].querySelector('input').value) || 0;
                const workers = parseFloat(workersRow.cells[d + 2].querySelector('input').value) || 0;
                const calves = parseFloat(calvesRow.cells[d + 2].querySelector('input').value) || 0;
                deductionsPerDay[d] = home + workers + calves;
                totalDeductionsRow.cells[d + 2].textContent = deductionsPerDay[d].toFixed(1);
                const net = amSums[d] + pmSums[d] - deductionsPerDay[d];
                netLitersRow.cells[d + 2].textContent = net.toFixed(1);
                homeSum += home;
                workersSum += workers;
                calvesSum += calves;
                totalDeductions += deductionsPerDay[d];
            }
            homeRow.cells[33].textContent = homeSum.toFixed(1);
            workersRow.cells[33].textContent = workersSum.toFixed(1);
            calvesRow.cells[33].textContent = calvesSum.toFixed(1);
            totalDeductionsRow.cells[33].textContent = totalDeductions.toFixed(1);
            const totalGross = totalAMAll + totalPMAll;
            const totalNet = totalGross - totalDeductions;
            netLitersRow.cells[33].textContent = totalNet.toFixed(1);

            // Update daily rankings for selected date
            updateDailyRankings(selectedDate);

            console.log(`Recalculated: AM Total=${totalAMAll.toFixed(1)}, PM Total=${totalPMAll.toFixed(1)}, Total Net=${totalNet.toFixed(1)}`);
        }

        function updateDailyRankings(day) {
            selectedDate = day;
            const dayIndex = parseInt(day) - 1;
            const topDailyTbody = document.getElementById('topDailyTable').getElementsByTagName('tbody')[0];
            const worstDailyTbody = document.getElementById('worstDailyTable').getElementsByTagName('tbody')[0];
            topDailyTbody.innerHTML = '';
            worstDailyTbody.innerHTML = '';

            // Update captions
            document.getElementById('topDailyCaption').textContent = `Top 5 Daily Milk Producers for ${currentMonth} ${day}`;
            document.getElementById('worstDailyCaption').textContent = `Worst 5 Daily Milk Producers for ${currentMonth} ${day}`;

            // Calculate daily totals for the selected day
            const cowDailyTotals = [];
            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            for (let i = 0; i < tableBody.rows.length; i += 2) {
                const amRow = tableBody.rows[i];
                const pmRow = tableBody.rows[i + 1];
                const displayName = pmRow.cells[0].textContent;
                const amVal = parseFloat(amRow.cells[dayIndex + 2].querySelector('input').value) || 0;
                const pmVal = parseFloat(pmRow.cells[dayIndex + 2].querySelector('input').value) || 0;
                cowDailyTotals.push({ cow: displayName, total: amVal + pmVal });
            }

            // Sort and filter
            const sorted = cowDailyTotals
                .filter(c => c.total > 0 || cowDailyTotals.every(c => c.total === 0))
                .sort((a, b) => b.total - a.total);
            const top5 = sorted.slice(0, 5);
            const worst5 = sorted.slice(-5).reverse();

            // Populate top 5
            if (sorted.length === 0 || top5.every(c => c.total === 0)) {
                const row = topDailyTbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = `No production data for ${currentMonth} ${day}`;
            } else {
                top5.forEach((cow, i) => {
                    const row = topDailyTbody.insertRow();
                    row.insertCell().textContent = i + 1;
                    row.insertCell().textContent = cow.cow;
                    row.insertCell().textContent = cow.total.toFixed(1);
                });
            }

            // Populate worst 5
            if (sorted.length === 0 || worst5.every(c => c.total === 0)) {
                const row = worstDailyTbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = `No production data for ${currentMonth} ${day}`;
            } else {
                worst5.forEach((cow, i) => {
                    const row = worstDailyTbody.insertRow();
                    row.insertCell().textContent = i + 1;
                    row.insertCell().textContent = cow.cow;
                    row.insertCell().textContent = cow.total.toFixed(1);
                });
            }
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const table = document.getElementById('milkTable');
            const rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    let cellText = cell.textContent || cell.innerText;
                    if (cell.querySelector('input')) {
                        cellText = cell.querySelector('input').value;
                    }
                    rowData.push(`"${cellText.replace(/"/g, '""')}"`);
                }
                csvContent += rowData.join(",") + "\r\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentMonth}_Records.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
