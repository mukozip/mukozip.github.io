<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Management App</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"] {
            width: 60px;
            padding: 4px;
        }
        input[type="text"], input[type="date"] {
            padding: 4px;
            margin: 5px;
            width: 150px;
        }
        button {
            padding: 8px 16px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .form-container {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
        .message {
            color: green;
            margin: 10px 0;
        }
        .ranking-section {
            margin-top: 30px;
        }
        .ranking-table {
            width: 50%;
            margin-bottom: 20px;
        }
        .ranking-table th {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <h1>Dairy Management App</h1>
    <p>Enter cow details (number and name) to track daily AM (Morning Milk) and PM (Evening Milk) production. After adding a cow, input milk values for each session. The app calculates totals, deductions, and lactation periods based on the current date (August 14, 2025). Data is saved locally and persists across page refreshes. Export to CSV for Excel use.</p>
    
    <div class="form-container">
        <label for="cowNo">Cow No:</label>
        <input type="text" id="cowNo" required placeholder="e.g., 297">
        
        <label for="cowName">Cow Name:</label>
        <input type="text" id="cowName" required placeholder="e.g., Mercy">
        
        <label for="calvingDate">Last Calving Date:</label>
        <input type="date" id="calvingDate" required>
        
        <label for="monthsPreg">Months of Pregnancy:</label>
        <input type="number" id="monthsPreg" step="0.1" min="0" placeholder="e.g., 3.4">
        
        <button type="button" onclick="addCowFromForm()">Add Cow</button>
    </div>
    <div id="message" class="message"></div>
    
    <label for="monthSelect">Month:</label>
    <select id="monthSelect" onchange="changeMonth(this.value)">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
    </select>
    <button onclick="saveCurrentMonth()">Save</button>
    <button onclick="exportToCSV()">Export to CSV</button>
    
    <table id="milkTable">
        <caption id="tableCaption">July Records</caption>
        <thead>
            <tr>
                <th>COW NO./NAME</th>
                <th>TIME</th>
                <!-- Day columns will be added dynamically -->
                <th>TOTAL DAILY PRODUCTION</th>
                <th>TOTAL MONTHLY PRODUCTION</th>
                <th>LAST CALVING DATE</th>
                <th>DAYS OF PDN SINCE CALVING</th>
                <th>MONTHS OF PREG</th>
            </tr>
        </thead>
        <tbody>
            <!-- Cows will be added here -->
        </tbody>
        <tfoot>
            <tr id="footerRowAM">
                <td></td>
                <td>AM</td>
                <!-- Day sum cells will be added dynamically -->
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr id="footerRowPM">
                <td></td>
                <td>PM</td>
                <!-- Day sum cells will be added dynamically -->
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <!-- Deductions rows will be added here -->
        </tfoot>
    </table>

    <div class="ranking-section">
        <h2>Top 5 Milk Producers</h2>
        <table class="ranking-table" id="topDailyTable">
            <caption>Top 5 Daily Milk Producers</caption>
            <thead>
                <tr><th>Day</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="topWeeklyTable">
            <caption>Top 5 Weekly Milk Producers</caption>
            <thead>
                <tr><th>Week</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="topMonthlyTable">
            <caption>Top 5 Monthly Milk Producers</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total Milk (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Worst 5 Milk Producers</h2>
        <table class="ranking-table" id="worstDailyTable">
            <caption>Worst 5 Daily Milk Producers</caption>
            <thead>
                <tr><th>Day</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="worstWeeklyTable">
            <caption>Worst 5 Weekly Milk Producers</caption>
            <thead>
                <tr><th>Week</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="worstMonthlyTable">
            <caption>Worst 5 Monthly Milk Producers</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total Milk (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const today = new Date(2025, 7, 14); // August 14, 2025 (month is 0-based)
        let cowCount = 0;
        let currentMonth = 'July';

        // Fixed cow data from Excel (without production)
        const fixedCowsFromExcel = [
            { cowNo: "297", displayName: "1. MERCY", calvingDateStr: "2024-03-01", monthsPreg: "4.66666666666667" },
            { cowNo: "413", displayName: "2. MAGRET", calvingDateStr: "2024-03-04", monthsPreg: "3.4" },
            { cowNo: "427", displayName: "3. CECE", calvingDateStr: "2024-05-15", monthsPreg: "3.2" },
            { cowNo: "425", displayName: "4. ANGEL", calvingDateStr: "2024-05-19", monthsPreg: "5.36666666666667" },
            { cowNo: "093", displayName: "5. RITAH", calvingDateStr: "2024-05-28", monthsPreg: "" },
            { cowNo: "059", displayName: "6. SUSAN", calvingDateStr: "2024-07-24", monthsPreg: "2.1" },
            { cowNo: "008", displayName: "7. FRIDA", calvingDateStr: "2024-07-26", monthsPreg: "3.46666666666667" },
            { cowNo: "434", displayName: "8. SHANA", calvingDateStr: "2024-10-06", monthsPreg: "1.56666666666667" },
            { cowNo: "083", displayName: "9. KATHY", calvingDateStr: "2024-10-27", monthsPreg: "" },
            { cowNo: "402", displayName: "10. KELLEN", calvingDateStr: "2024-11-13", monthsPreg: "" },
            { cowNo: "098", displayName: "11. JACKLINE", calvingDateStr: "2024-11-28", monthsPreg: "" },
            { cowNo: "421", displayName: "12. EVA", calvingDateStr: "2024-11-28", monthsPreg: "" },
            { cowNo: "099", displayName: "13. SARAH", calvingDateStr: "2024-12-04", monthsPreg: "" },
            { cowNo: "521", displayName: "14. KEZA", calvingDateStr: "2024-12-09", monthsPreg: "" },
            { cowNo: "024", displayName: "15. KIRABO", calvingDateStr: "2024-12-11", monthsPreg: "" },
            { cowNo: "403", displayName: "16. PEACE", calvingDateStr: "2024-12-26", monthsPreg: "" },
            { cowNo: "418", displayName: "17. IRENE", calvingDateStr: "2025-01-02", monthsPreg: "" },
            { cowNo: "296", displayName: "18. JOAN", calvingDateStr: "2025-01-13", monthsPreg: "" },
            { cowNo: "511", displayName: "19. SIIMA", calvingDateStr: "2025-01-02", monthsPreg: "" },
            { cowNo: "021", displayName: "20. BIRA", calvingDateStr: "2025-01-02", monthsPreg: "" }
        ];

        // Initial production for July from Excel
        const initialJulyProductions = [
            { amValues: ["4.5", "4.5", "4.5", "4.5", "5", "", "4.5", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "5", "5.5", "5", "5.5", "", "6.5", "5.5", "5", "5", "5.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "3", "2.5", "2", "2", "2", "2.5", "2.5", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "3", "4", "3", "3.5", "", "3.5", "3.5", "3.5", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "2", "2", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "4", "4", "4", "4", "", "4", "4", "4", "3.5", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2", "2", "2", "1.5", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4.5", "5", "4", "4.5", "4.5", "", "4.5", "5.5", "5", "5.5", "4.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3", "3", "3", "2.5", "3", "3", "3", "3", "3", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["6", "5.5", "4.5", "5", "4.5", "", "4", "4", "3.5", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2", "2", "3", "2", "2", "2", "2", "3", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3.5", "3", "3", "3", "3.5", "", "3", "3.5", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { amValues: ["4.5", "4.5", "4", "4", "4", "", "4", "3.5", "4", "3.5", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2", "2", "2.5", "2", "2", "2", "2", "2", "2", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4.5", "4", "4", "4", "4", "", "2.5", "4", "2.5", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: Array(31).fill("0") },
            { amValues: ["7", "6.5", "7", "5", "5", "", "6", "6", "6", "6", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "4.5", "3", "2", "3.5", "4", "3", "2", "2", "2.5", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["3", "3", "3", "2.5", "3.5", "", "3", "3", "2.5", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7", "7", "7", "7", "7.5", "", "6.5", "7", "7", "7", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "5", "3.5", "4", "4", "4", "4", "3.5", "3", "3", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4", "4", "4", "4", "4", "", "4", "4", "4", "4", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["4", "4", "4", "4", "3", "", "3", "4", "3", "3", "2", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "2", "2", "2.5", "1.5", "1.5", "1.5", "2", "2", "1", "1", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "4.5", "4.5", "5.5", "4.5", "", "4", "5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2.5", "2.5", "2.5", "2", "2", "2.5", "2", "2", "2", "2", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7.5", "7", "7", "7", "6", "", "7", "8", "7", "7", "7", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "4.5", "4.5", "4.5", "4", "3.5", "3.5", "3.5", "4", "4", "4", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["7", "6.5", "7", "6.5", "7", "", "7.5", "7", "7", "6.5", "6.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["4", "3", "3", "3", "3.5", "3", "3.5", "3", "3", "3", "3.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["8", "7", "7", "6.5", "6.5", "", "8", "6", "6.5", "5.5", "6", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["5", "4", "4", "3.5", "4", "4", "4", "3", "3", "3", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["5", "5.5", "6", "6", "5", "", "5.5", "5.5", "6", "5.5", "5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["3.5", "3", "4", "4", "3", "3.5", "3", "3.5", "4", "3.5", "3", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] },
            { amValues: ["2", "2", "2", "1", "1", "", "3", "4", "4", "3", "2.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""], 
              pmValues: ["2", "1", "1.5", "1.5", "1.5", "1.5", "2", "1.5", "1", "1", "1.5", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""] }
        ];

        let fixedCows = JSON.parse(localStorage.getItem('fixedCows')) || fixedCowsFromExcel;
        let productionData = JSON.parse(localStorage.getItem('productionData')) || {};

        if (!productionData['July']) {
            productionData['July'] = {
                productions: initialJulyProductions,
                deductions: {
                    homeUse: Array(31).fill(''),
                    workersMilk: Array(31).fill(''),
                    calvesMilk: Array(31).fill('')
                }
            };
        }

        localStorage.setItem('fixedCows', JSON.stringify(fixedCows));
        localStorage.setItem('productionData', JSON.stringify(productionData));

        // Load initial month
        window.onload = function() {
            document.getElementById('monthSelect').value = currentMonth;
            loadMonth(currentMonth);
        };

        function getDaysInMonth(month, year) {
            const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 
                                'July', 'August', 'September', 'October', 'November', 'December'].indexOf(month);
            return new Date(year, monthIndex + 1, 0).getDate();
        }

        function changeMonth(newMonth) {
            saveCurrentMonth();
            currentMonth = newMonth;
            loadMonth(currentMonth);
        }

        function saveCurrentMonth() {
            const daysInMonth = getDaysInMonth(currentMonth, 2025);
            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const productions = [];
            for (let i = 0; i < tbody.rows.length; i += 2) {
                const amRow = tbody.rows[i];
                const pmRow = tbody.rows[i + 1];
                const amValues = [];
                const pmValues = [];
                for (let d = 0; d < daysInMonth; d++) {
                    amValues[d] = amRow.cells[d + 2].querySelector('input').value;
                    pmValues[d] = pmRow.cells[d + 2].querySelector('input').value;
                }
                productions.push({amValues, pmValues});
            }
            productionData[currentMonth].productions = productions;

            const deductions = productionData[currentMonth].deductions;
            for (let d = 0; d < daysInMonth; d++) {
                deductions.homeUse[d] = document.getElementById('homeUseRow').cells[d + 2].querySelector('input').value;
                deductions.workersMilk[d] = document.getElementById('workersMilkRow').cells[d + 2].querySelector('input').value;
                deductions.calvesMilk[d] = document.getElementById('calvesMilkRow').cells[d + 2].querySelector('input').value;
            }

            localStorage.setItem('productionData', JSON.stringify(productionData));
        }

        function loadMonth(month) {
            const year = 2025;
            const daysInMonth = getDaysInMonth(month, year);

            // Update header row with day columns
            const thead = document.getElementById('milkTable').getElementsByTagName('thead')[0];
            const headerRow = thead.rows[0];
            while (headerRow.cells.length > 2) {
                headerRow.deleteCell(2);
            }
            for (let d = 1; d <= daysInMonth; d++) {
                const th = document.createElement('th');
                th.textContent = d;
                headerRow.insertBefore(th, headerRow.cells[headerRow.cells.length - 3]);
            }

            // Update footerRowAM and footerRowPM with day cells
            const footerRowAM = document.getElementById('footerRowAM');
            while (footerRowAM.cells.length > 2) {
                footerRowAM.deleteCell(2);
            }
            for (let d = 0; d < daysInMonth; d++) {
                footerRowAM.insertCell();
            }
            while (footerRowAM.cells.length < daysInMonth + 7) { // +2 for labels, +5 for totals
                footerRowAM.insertCell();
            }

            const footerRowPM = document.getElementById('footerRowPM');
            while (footerRowPM.cells.length > 2) {
                footerRowPM.deleteCell(2);
            }
            for (let d = 0; d < daysInMonth; d++) {
                footerRowPM.insertCell();
            }
            while (footerRowPM.cells.length < daysInMonth + 7) {
                footerRowPM.insertCell();
            }

            if (!productionData[month]) {
                productionData[month] = {
                    productions: fixedCows.map(() => ({amValues: Array(daysInMonth).fill(''), pmValues: Array(daysInMonth).fill('')})),
                    deductions: {
                        homeUse: Array(daysInMonth).fill(''),
                        workersMilk: Array(daysInMonth).fill(''),
                        calvesMilk: Array(daysInMonth).fill('')
                    }
                };
            }

            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            const productions = productionData[month].productions;
            fixedCows.forEach((cow, index) => {
                addCowToTable(cow, productions[index].amValues, productions[index].pmValues, daysInMonth);
            });

            removeDeductionsRows();
            addDeductionsRows(productionData[month].deductions, daysInMonth);

            document.getElementById('tableCaption').textContent = `${month} Records`;

            recalculate(daysInMonth);
        }

        function removeDeductionsRows() {
            ['homeUseRow', 'workersMilkRow', 'calvesMilkRow', 'totalDeductionsRow', 'netLitersRow'].forEach(id => {
                const row = document.getElementById(id);
                if (row) row.remove();
            });
        }

        function addDeductionsRows(deductions, daysInMonth) {
            const tfoot = document.getElementById('milkTable').getElementsByTagName('tfoot')[0];

            // Home Use Row
            const homeRow = tfoot.insertRow();
            homeRow.id = 'homeUseRow';
            const labelCellHome = homeRow.insertCell();
            labelCellHome.colSpan = 2;
            labelCellHome.textContent = 'Home Use';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = homeRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.homeUse[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(getDaysInMonth(currentMonth, 2025)); });
                cell.appendChild(input);
            }
            homeRow.insertCell(); // total
            homeRow.insertCell().colSpan = 4;

            // Workers Milk Row
            const workersRow = tfoot.insertRow();
            workersRow.id = 'workersMilkRow';
            const labelCellWorkers = workersRow.insertCell();
            labelCellWorkers.colSpan = 2;
            labelCellWorkers.textContent = 'Workers Milk';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = workersRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.workersMilk[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(getDaysInMonth(currentMonth, 2025)); });
                cell.appendChild(input);
            }
            workersRow.insertCell(); // total
            workersRow.insertCell().colSpan = 4;

            // Calves Milk Row
            const calvesRow = tfoot.insertRow();
            calvesRow.id = 'calvesMilkRow';
            const labelCellCalves = calvesRow.insertCell();
            labelCellCalves.colSpan = 2;
            labelCellCalves.textContent = 'Calves Milk';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = calvesRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.calvesMilk[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(getDaysInMonth(currentMonth, 2025)); });
                cell.appendChild(input);
            }
            calvesRow.insertCell(); // total
            calvesRow.insertCell().colSpan = 4;

            // Total Deductions Row (calculated)
            const totalDeductionsRow = tfoot.insertRow();
            totalDeductionsRow.id = 'totalDeductionsRow';
            const labelCellTotalDeductions = totalDeductionsRow.insertCell();
            labelCellTotalDeductions.colSpan = 2;
            labelCellTotalDeductions.textContent = 'Total Deductions';
            for (let d = 0; d < daysInMonth; d++) {
                totalDeductionsRow.insertCell();
            }
            totalDeductionsRow.insertCell(); // total
            totalDeductionsRow.insertCell().colSpan = 4;

            // Net Liters Row (calculated)
            const netLitersRow = tfoot.insertRow();
            netLitersRow.id = 'netLitersRow';
            const labelCellNet = netLitersRow.insertCell();
            labelCellNet.colSpan = 2;
            labelCellNet.textContent = 'Net Liters';
            for (let d = 0; d < daysInMonth; d++) {
                netLitersRow.insertCell();
            }
            netLitersRow.insertCell(); // total
            netLitersRow.insertCell().colSpan = 4;
        }

        function addCowFromForm() {
            const cowNo = document.getElementById('cowNo').value.trim();
            const cowName = document.getElementById('cowName').value.trim();
            const calvingDateStr = document.getElementById('calvingDate').value;
            const monthsPreg = document.getElementById('monthsPreg').value || '';

            if (!cowNo || !cowName || !calvingDateStr) {
                alert('Please fill in all required fields (Cow No, Cow Name, Last Calving Date).');
                return;
            }

            cowCount++;
            const displayName = `${cowCount}. ${cowName}`;
            const newCow = {
                cowNo,
                displayName,
                calvingDateStr,
                monthsPreg
            };

            fixedCows.push(newCow);
            localStorage.setItem('fixedCows', JSON.stringify(fixedCows));

            // Add new production to all months
            for (const month in productionData) {
                const days = getDaysInMonth(month, 2025);
                productionData[month].productions.push({amValues: Array(days).fill(''), pmValues: Array(days).fill('')});
            }
            localStorage.setItem('productionData', JSON.stringify(productionData));

            // Reload current month to add the new cow
            loadMonth(currentMonth);

            // Clear form inputs
            document.getElementById('cowNo').value = '';
            document.getElementById('cowName').value = '';
            document.getElementById('calvingDate').value = '';
            document.getElementById('monthsPreg').value = '';

            document.getElementById('message').textContent = `Cow ${displayName} added successfully!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function addCowToTable(cow, amValues, pmValues, daysInMonth) {
            const { cowNo = '', displayName = '', calvingDateStr = '', monthsPreg = '' } = cow;
            const calving = calvingDateStr ? new Date(calvingDateStr) : null;
            const daysSince = calving ? Math.floor((today - calving) / (1000 * 60 * 60 * 24)) : '';

            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];

            // AM Row (Morning Milk)
            const amRow = tableBody.insertRow();
            amRow.insertCell().textContent = cowNo;
            amRow.insertCell().textContent = 'AM';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = amRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = amValues[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            amRow.insertCell(); // TOTAL DAILY PRODUCTION
            amRow.insertCell(); // TOTAL MONTHLY PRODUCTION (empty for AM)
            amRow.insertCell(); // LAST CALVING DATE (empty for AM)
            amRow.insertCell(); // DAYS SINCE (empty for AM)
            amRow.insertCell(); // MONTHS PREG (empty for AM)

            // PM Row (Evening Milk)
            const pmRow = tableBody.insertRow();
            pmRow.insertCell().textContent = displayName;
            pmRow.insertCell().textContent = 'PM';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = pmRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = pmValues[d] || '';
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            pmRow.insertCell(); // TOTAL DAILY PRODUCTION
            pmRow.insertCell(); // TOTAL MONTHLY PRODUCTION
            pmRow.insertCell().textContent = calvingDateStr;
            pmRow.insertCell().textContent = daysSince;
            pmRow.insertCell().textContent = monthsPreg;
        }

        function recalculate(daysInMonth) {
            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const footerRowAM = document.getElementById('footerRowAM');
            const footerRowPM = document.getElementById('footerRowPM');
            const homeRow = document.getElementById('homeUseRow');
            const workersRow = document.getElementById('workersMilkRow');
            const calvesRow = document.getElementById('calvesMilkRow');
            const totalDeductionsRow = document.getElementById('totalDeductionsRow');
            const netLitersRow = document.getElementById('netLitersRow');
            const amSums = Array(daysInMonth).fill(0);
            const pmSums = Array(daysInMonth).fill(0);
            let totalAMAll = 0;
            let totalPMAll = 0;

            // Calculate cow totals and collect data for rankings
            const cowDailyTotals = Array(daysInMonth).fill().map(() => []);
            const cowMonthlyTotals = [];
            for (let i = 0; i < tableBody.rows.length; i += 2) {
                const amRow = tableBody.rows[i];
                const pmRow = tableBody.rows[i + 1];
                const displayName = pmRow.cells[0].textContent;

                // Calculate AM totals
                let amSum = 0;
                for (let d = 0; d < daysInMonth; d++) {
                    const val = parseFloat(amRow.cells[d + 2].querySelector('input').value) || 0;
                    amSum += val;
                    amSums[d] += val;
                    cowDailyTotals[d].push({ cow: displayName, total: val + (parseFloat(pmRow.cells[d + 2].querySelector('input').value) || 0) });
                }
                amRow.cells[daysInMonth + 2].textContent = amSum.toFixed(1); // TOTAL DAILY PRODUCTION for AM

                // Calculate PM totals
                let pmSum = 0;
                for (let d = 0; d < daysInMonth; d++) {
                    const val = parseFloat(pmRow.cells[d + 2].querySelector('input').value) || 0;
                    pmSum += val;
                    pmSums[d] += val;
                }
                pmRow.cells[daysInMonth + 2].textContent = pmSum.toFixed(1); // TOTAL DAILY PRODUCTION for PM
                pmRow.cells[daysInMonth + 3].textContent = (amSum + pmSum).toFixed(1); // TOTAL MONTHLY PRODUCTION

                totalAMAll += amSum;
                totalPMAll += pmSum;
                cowMonthlyTotals.push({ cow: displayName, total: amSum + pmSum });
            }

            // Update footer sums for AM
            for (let d = 0; d < daysInMonth; d++) {
                footerRowAM.cells[d + 2].textContent = amSums[d].toFixed(1);
            }
            footerRowAM.cells[daysInMonth + 2].textContent = totalAMAll.toFixed(1); // Total AM across all cows

            // Update footer sums for PM
            for (let d = 0; d < daysInMonth; d++) {
                footerRowPM.cells[d + 2].textContent = pmSums[d].toFixed(1);
            }
            footerRowPM.cells[daysInMonth + 2].textContent = totalPMAll.toFixed(1); // Total PM across all cows

            // Calculate deductions and net
            let homeSum = 0;
            let workersSum = 0;
            let calvesSum = 0;
            const deductionsPerDay = Array(daysInMonth).fill(0);
            let totalDeductions = 0;
            for (let d = 0; d < daysInMonth; d++) {
                const home = parseFloat(homeRow.cells[d + 2].querySelector('input').value) || 0;
                const workers = parseFloat(workersRow.cells[d + 2].querySelector('input').value) || 0;
                const calves = parseFloat(calvesRow.cells[d + 2].querySelector('input').value) || 0;
                deductionsPerDay[d] = home + workers + calves;
                totalDeductionsRow.cells[d + 2].textContent = deductionsPerDay[d].toFixed(1);
                const net = amSums[d] + pmSums[d] - deductionsPerDay[d];
                netLitersRow.cells[d + 2].textContent = net.toFixed(1);
                homeSum += home;
                workersSum += workers;
                calvesSum += calves;
                totalDeductions += deductionsPerDay[d];
            }
            homeRow.cells[daysInMonth + 2].textContent = homeSum.toFixed(1);
            workersRow.cells[daysInMonth + 2].textContent = workersSum.toFixed(1);
            calvesRow.cells[daysInMonth + 2].textContent = calvesSum.toFixed(1);
            totalDeductionsRow.cells[daysInMonth + 2].textContent = totalDeductions.toFixed(1);
            const totalGross = totalAMAll + totalPMAll;
            const totalNet = totalGross - totalDeductions;
            netLitersRow.cells[daysInMonth + 2].textContent = totalNet.toFixed(1);

            // Update rankings
            updateRankings(cowDailyTotals, cowMonthlyTotals, daysInMonth);

            console.log(`Recalculated: AM Total=${totalAMAll.toFixed(1)}, PM Total=${totalPMAll.toFixed(1)}, Total Net=${totalNet.toFixed(1)}`);
        }

        function updateRankings(cowDailyTotals, cowMonthlyTotals, daysInMonth) {
            // Daily Rankings
            const topDailyTbody = document.getElementById('topDailyTable').getElementsByTagName('tbody')[0];
            const worstDailyTbody = document.getElementById('worstDailyTable').getElementsByTagName('tbody')[0];
            topDailyTbody.innerHTML = '';
            worstDailyTbody.innerHTML = '';
            for (let d = 0; d < daysInMonth; d++) {
                const sorted = cowDailyTotals[d]
                    .filter(c => c.total > 0 || cowDailyTotals[d].every(c => c.total === 0))
                    .sort((a, b) => b.total - a.total);
                const top5 = sorted.slice(0, 5);
                const worst5 = sorted.slice(-5).reverse();
                if (sorted.length > 0) {
                    const topRow = topDailyTbody.insertRow();
                    topRow.insertCell().textContent = d + 1;
                    top5.forEach(cow => topRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)} L)`);
                    while (topRow.cells.length < 6) topRow.insertCell().textContent = '';
                    const worstRow = worstDailyTbody.insertRow();
                    worstRow.insertCell().textContent = d + 1;
                    worst5.forEach(cow => worstRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)} L)`);
                    while (worstRow.cells.length < 6) worstRow.insertCell().textContent = '';
                }
            }

            // Weekly Rankings
            const weeks = [];
            for (let start = 0; start < daysInMonth; start += 7) {
                weeks.push([start, Math.min(start + 7, daysInMonth)]);
            }
            const cowWeeklyTotals = weeks.map(() => fixedCows.map(cow => ({ cow: cow.displayName, total: 0 })));
            fixedCows.forEach((cow, i) => {
                const prod = productionData[currentMonth].productions[i];
                weeks.forEach(([start, end], w) => {
                    let total = 0;
                    for (let d = start; d < end; d++) {
                        total += (parseFloat(prod.amValues[d]) || 0) + (parseFloat(prod.pmValues[d]) || 0);
                    }
                    cowWeeklyTotals[w][i].total = total;
                });
            });

            const topWeeklyTbody = document.getElementById('topWeeklyTable').getElementsByTagName('tbody')[0];
            const worstWeeklyTbody = document.getElementById('worstWeeklyTable').getElementsByTagName('tbody')[0];
            topWeeklyTbody.innerHTML = '';
            worstWeeklyTbody.innerHTML = '';
            weeks.forEach(([start, end], w) => {
                const sorted = cowWeeklyTotals[w]
                    .filter(c => c.total > 0 || cowWeeklyTotals[w].every(c => c.total === 0))
                    .sort((a, b) => b.total - a.total);
                const top5 = sorted.slice(0, 5);
                const worst5 = sorted.slice(-5).reverse();
                if (sorted.length > 0) {
                    const topRow = topWeeklyTbody.insertRow();
                    topRow.insertCell().textContent = `Week ${w + 1} (Days ${start + 1}-${end})`;
                    top5.forEach(cow => topRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)} L)`);
                    while (topRow.cells.length < 6) topRow.insertCell().textContent = '';
                    const worstRow = worstWeeklyTbody.insertRow();
                    worstRow.insertCell().textContent = `Week ${w + 1} (Days ${start + 1}-${end})`;
                    worst5.forEach(cow => worstRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)} L)`);
                    while (worstRow.cells.length < 6) worstRow.insertCell().textContent = '';
                }
            });

            // Monthly Rankings
            const sortedMonthly = cowMonthlyTotals.sort((a, b) => b.total - a.total);
            const topMonthly = sortedMonthly.slice(0, 5);
            const worstMonthly = sortedMonthly.slice(-5).reverse();
            const topMonthlyTbody = document.getElementById('topMonthlyTable').getElementsByTagName('tbody')[0];
            const worstMonthlyTbody = document.getElementById('worstMonthlyTable').getElementsByTagName('tbody')[0];
            topMonthlyTbody.innerHTML = '';
            worstMonthlyTbody.innerHTML = '';
            topMonthly.forEach((cow, i) => {
                const row = topMonthlyTbody.insertRow();
                row.insertCell().textContent = i + 1;
                row.insertCell().textContent = cow.cow;
                row.insertCell().textContent = cow.total.toFixed(1);
            });
            worstMonthly.forEach((cow, i) => {
                const row = worstMonthlyTbody.insertRow();
                row.insertCell().textContent = i + 1;
                row.insertCell().textContent = cow.cow;
                row.insertCell().textContent = cow.total.toFixed(1);
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const table = document.getElementById('milkTable');
            const rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    let cellText = cell.textContent || cell.innerText;
                    if (cell.querySelector('input')) {
                        cellText = cell.querySelector('input').value;
                    }
                    rowData.push(`"${cellText.replace(/"/g, '""')}"`);
                }
                csvContent += rowData.join(",") + "\r\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentMonth}_Records.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
