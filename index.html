<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dairy Farm Milk Record - Mukozi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #f8f9fa; }
    h1, h2 { color: #2c3e50; }

    .controls { margin: 20px 0; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }

    .table-wrapper { overflow-x: auto; max-width: 100%; position: relative; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; background: white; }

    th, td { border: 1px solid #ddd; padding: 7px 9px; text-align: center; font-size: 0.93em; white-space: nowrap; }

    th.fixed, td.fixed { position: sticky; left: 0; background: #f1f5f9; z-index: 3; }
    th.fixed:nth-child(1), td.fixed:nth-child(1) { left: 0;      min-width: 70px; }
    th.fixed:nth-child(2), td.fixed:nth-child(2) { left: 70px;   min-width: 140px; }
    th.fixed:nth-child(3), td.fixed:nth-child(3) { left: 210px;  min-width: 110px; }
    th.fixed:nth-child(4), td.fixed:nth-child(4) { left: 320px;  min-width: 70px;  }
    th.fixed:nth-child(5), td.fixed:nth-child(5) { left: 390px;  min-width: 140px; }

    thead th { background: #3498db; color: white; position: sticky; top: 0; z-index: 4; }
    thead th.fixed { z-index: 5; background: #2980b9; }

    td:nth-child(1) { font-weight: bold; text-align: center; }
    td:nth-child(2) { text-align: left; font-weight: bold; }

    td.editable:hover { background: #e3f2fd; cursor: pointer; }

    input[type="number"], input[type="text"], input[type="date"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { width: 65px; text-align: center; }
    input[type="text"]   { width: 120px; }

    button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 0 4px; }
    .btn-primary  { background: #3498db; color: white; }
    .btn-success  { background: #27ae60; color: white; }
    .btn-warning  { background: #f39c12; color: white; }
    .btn-danger   { background: #e74c3c; color: white; }
    button:hover { opacity: 0.9; }

    .form-add-cow { margin: 24px 0; padding: 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }

    .hiddenRow { display: none; }

    #stats { margin-top: 28px; padding: 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }

    .deduction-cell { background: #fff3cd; font-size: 0.88em; vertical-align: top; line-height: 1.4; }
    .deduction-am   { background: #fffde7; padding: 5px; margin-bottom: 8px; border-radius: 4px; }
    .deduction-pm   { background: #fefce8; padding: 5px; border-radius: 4px; }
    .net-am-pm      { background: #d1fae5; font-weight: bold; padding: 4px; margin: 6px 0; border-radius: 4px; font-size: 0.95em; }
    .net-daily      { background: #a7f3d0; font-weight: bold; font-size: 1em; padding: 6px; margin-top: 8px; border-radius: 4px; }
    .net-cell       { background: #d4edda; font-weight: bold; font-size: 1.05em; }

    .daily-net-row td { background: #e8f5e9; font-weight: bold; }
  </style>
</head>
<body>

<h1>Dairy Milk Record</h1>

<div class="controls">
  <label>Year: <select id="yearSel">
    <option value="2024">2024</option>
    <option value="2025">2025</option>
    <option value="2026" selected>2026</option>
    <option value="2027">2027</option>
    <option value="2028">2028</option>
  </select></label>

  <label>Month: <select id="monthSel">
    <option value="January">January</option>
    <option value="February">February</option>
    <option value="March">March</option>
    <option value="April">April</option>
    <option value="May">May</option>
    <option value="June">June</option>
    <option value="July">July</option>
    <option value="August">August</option>
    <option value="September">September</option>
    <option value="October">October</option>
    <option value="November">November</option>
    <option value="December" selected>December</option>
  </select></label>

  <button class="btn-primary" onclick="exportToExcel()">Export to Excel</button>
  <button class="btn-success" onclick="saveAsJson()">Save as JSON</button>
  <button class="btn-warning" onclick="unhideAll()">Unhide All</button>

  <label style="margin-left:16px">Import JSON: <input type="file" id="importJson" accept=".json"/></label>

  <small style="color:#c0392b; margin-left:16px;">
    Double-click Tag / Name / Calving / Preg to edit • Use Delete to remove cow
  </small>
</div>

<div class="form-add-cow">
  <h3>Add New Cow</h3>
  <label>Tag/No: <input type="text" id="newNo" placeholder="e.g. 142" size="8"></label>
  <label>Name: <input type="text" id="newName" placeholder="e.g. LILLY" style="width:140px;"></label>
  <label>Calving: <input type="date" id="newCalving"></label>
  <label>Preg: <input type="text" id="newPreg" placeholder="0 or 1.5 or empty" size="8"></label>
  <button class="btn-success" onclick="addNewCow()">Add Cow</button>
</div>

<h2 id="caption"></h2>

<div class="table-wrapper">
  <table id="milkTable">
    <thead><tr id="headerRow"></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="stats">
  <h3>Quick Stats</h3>
  <p>Top 5 cows:</p><ul id="topList"></ul>
  <p>Bottom 5 cows:</p><ul id="lowList"></ul>
</div>

<script>
// ──────────────────────────────────────────────
// DATA & CORE
// ──────────────────────────────────────────────

const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

let cows = JSON.parse(localStorage.getItem("cowList")) || [
  {no:"093", name:"RITAH",   calving:"2024-05-28", preg:""},
  {no:"434", name:"SHANA",   calving:"2024-10-06", preg:"1.6"},
  {no:"083", name:"KATHY",   calving:"2024-10-27", preg:""},
  {no:"402", name:"KELLEN",  calving:"2024-11-13", preg:""},
  {no:"098", name:"JACKLINE",calving:"2025-04-12", preg:"0"},
  {no:"421", name:"EVA",     calving:"2025-05-17", preg:"0"},
  {no:"099", name:"SARAH",   calving:"2025-04-20", preg:"0"},
  {no:"521", name:"KEZA",    calving:"2025-03-11", preg:"0"},
  {no:"539", name:"KIRABO",  calving:"2025-04-25", preg:"0"},
  {no:"403", name:"PEACE",   calving:"2025-05-10", preg:"0"},
  {no:"418", name:"IRENE",   calving:"2025-05-17", preg:"0"},
  {no:"296", name:"JOAN",    calving:"2025-05-28", preg:"0"},
  {no:"511", name:"SIIMA",   calving:"2025-06-22", preg:"0"},
  {no:"021", name:"BIIRA",   calving:"2025-06-24", preg:"0"},
  {no:"502", name:"RUTH",    calving:"2024-07-07", preg:"0"},
  {no:"010", name:"DEBRA",   calving:"2025-07-08", preg:"0"},
  {no:"516", name:"NAKATO",  calving:"2025-07-19", preg:"0"},
  {no:"535", name:"FIONA",   calving:"2025-07-21", preg:"0"},
  {no:"134", name:"BEATRICE",calving:"2025-08-02", preg:"0"},
  {no:"011", name:"NINA",    calving:"2025-08-04", preg:"0"},
  {no:"100", name:"KARUNGI", calving:"2025-07-09", preg:"0"},
  {no:"935", name:"PROSSY",  calving:"2025-08-23", preg:"0"},
  {no:"404", name:"KYOOZI",  calving:"2025-08-28", preg:"0"},
  {no:"013", name:"BELLA",   calving:"2025-09-05", preg:"0"},
  {no:"425", name:"ANGEL",   calving:"2025-11-02", preg:"0"},
  {no:"297", name:"MERCY",   calving:"2025-11-30", preg:"0"}
];

let year = 2026;
let month = "January";
let state = JSON.parse(localStorage.getItem("dairyData")) || {};

function getKey() { return year + "_" + month; }

function initMonth() {
  const key = getKey();
  if (!state[key]) {
    const monthIndex = MONTHS.indexOf(month);
    if (monthIndex === -1) return { prod: [], deductions: {}, hidden: [] };

    const days = new Date(year, monthIndex + 1, 0).getDate();

    state[key] = {
      prod: cows.map(() => ({ am: Array(days).fill(""), pm: Array(days).fill("") })),
      deductions: {
        homeAM: Array(days).fill(""), workersAM: Array(days).fill(""), calvesAM: Array(days).fill(""),
        homePM: Array(days).fill(""), workersPM: Array(days).fill(""), calvesPM: Array(days).fill("")
      },
      hidden: Array(cows.length).fill(false)
    };
    localStorage.setItem("dairyData", JSON.stringify(state));
  }
  return state[key];
}

// ──────────────────────────────────────────────
// RENDER (with separate AM/PM net)
// ──────────────────────────────────────────────

function render() {
  const data = initMonth();
  const days = data.prod?.[0]?.am?.length || 31;

  document.getElementById("caption").textContent = `${month} ${year}`;

  let header = `
    <th class="fixed">Tag/No</th>
    <th class="fixed">Name</th>
    <th class="fixed">Calving</th>
    <th class="fixed">Preg</th>
    <th class="fixed">Actions</th>`;
  for (let d = 1; d <= days; d++) {
    header += `<th>${d}<br>AM</th><th>${d}<br>PM</th>`;
  }
  header += "<th>Total (L)</th>";
  document.getElementById("headerRow").innerHTML = header;

  let body = "", grossMonthly = 0;
  const dailyAM = Array(days).fill(0);
  const dailyPM = Array(days).fill(0);

  cows.forEach((cow, i) => {
    const hidden = data.hidden[i] ?? false;
    let row = `<tr class="${hidden ? 'hiddenRow' : ''}" data-cow-index="${i}">
      <td class="fixed editable" ondblclick="editCow(${i}, this, 'no')">${cow.no || '-'}</td>
      <td class="fixed editable" ondblclick="editCow(${i}, this, 'name')">${cow.name || '-'}</td>
      <td class="fixed editable" ondblclick="editCow(${i}, this, 'calving')">${cow.calving || '-'}</td>
      <td class="fixed editable" ondblclick="editCow(${i}, this, 'preg')">${cow.preg || '-'}</td>
      <td class="fixed">
        <button class="btn-danger" onclick="toggleHide(${i})">${hidden ? 'Show' : 'Hide'}</button>
        <button class="btn-warning" onclick="deleteCow(${i})">Delete</button>
      </td>`;

    let cowTotal = 0;
    for (let d = 0; d < days; d++) {
      const am = data.prod[i]?.am?.[d] ?? "";
      const pm = data.prod[i]?.pm?.[d] ?? "";
      const amVal = +am || 0;
      const pmVal = +pm || 0;
      if (!hidden) {
        cowTotal += amVal + pmVal;
        dailyAM[d] += amVal;
        dailyPM[d] += pmVal;
      }
      row += `<td><input type="number" step="0.1" value="${am}" onchange="updateProd(${i},${d},'am',this.value)"></td>
              <td><input type="number" step="0.1" value="${pm}" onchange="updateProd(${i},${d},'pm',this.value)"></td>`;
    }
    grossMonthly += cowTotal;
    row += `<td>${cowTotal ? cowTotal.toFixed(1) : '-'}</td></tr>`;
    body += row;
  });

  document.querySelector("tbody").innerHTML = body;

  renderDeductions(days, data, dailyAM, dailyPM);
  updateDashboard(days, data);
}

function renderDeductions(days, data, dailyAM, dailyPM) {
  if (!data.deductions) return;

  let html = `<tr style="background:#fff3cd">
    <td class="fixed" colspan="5"><b>Deductions & Net</b></td>`;

  let totalDedAM = 0, totalDedPM = 0;
  const dailyNet = [];

  for (let d = 0; d < days; d++) {
    const hAM   = +data.deductions.homeAM?.[d]    || 0;
    const wAM   = +data.deductions.workersAM?.[d] || 0;
    const caAM  = +data.deductions.calvesAM?.[d]  || 0;
    const dedAM = hAM + wAM + caAM;
    totalDedAM += dedAM;
    const netAM = dailyAM[d] - dedAM;

    const hPM   = +data.deductions.homePM?.[d]    || 0;
    const wPM   = +data.deductions.workersPM?.[d] || 0;
    const caPM  = +data.deductions.calvesPM?.[d]  || 0;
    const dedPM = hPM + wPM + caPM;
    totalDedPM += dedPM;
    const netPM = dailyPM[d] - dedPM;

    const dayNet = netAM + netPM;
    dailyNet.push(dayNet);

    html += `<td class="deduction-cell">
      <div class="deduction-am">
        <strong>AM:</strong><br>
        Home <input type="number" step="0.1" value="${hAM}"   onchange="updateDed(${d},'homeAM',this.value)"><br>
        Workers <input type="number" step="0.1" value="${wAM}" onchange="updateDed(${d},'workersAM',this.value)"><br>
        Calf <input type="number" step="0.1" value="${caAM}"  onchange="updateDed(${d},'calvesAM',this.value)"><br>
        <div class="net-am-pm">Net AM: ${netAM.toFixed(1)}</div>
      </div>
      <div class="deduction-pm" style="margin-top:12px;">
        <strong>PM:</strong><br>
        Home <input type="number" step="0.1" value="${hPM}"   onchange="updateDed(${d},'homePM',this.value)"><br>
        Workers <input type="number" step="0.1" value="${wPM}" onchange="updateDed(${d},'workersPM',this.value)"><br>
        Calf <input type="number" step="0.1" value="${caPM}"  onchange="updateDed(${d},'calvesPM',this.value)"><br>
        <div class="net-am-pm">Net PM: ${netPM.toFixed(1)}</div>
      </div>
      <div class="net-daily">Daily Net: ${dayNet.toFixed(1)}</div>
    </td><td></td>`;
  }

  html += `<td class="net-cell">${(totalDedAM + totalDedPM).toFixed(1)}</td></tr>`;

  html += `<tr class="daily-net-row">
    <td class="fixed" colspan="5"><b>Daily Net Saleable</b></td>`;
  dailyNet.forEach(net => {
    html += `<td colspan="2" class="net-daily">${net.toFixed(1)}</td>`;
  });
  html += `<td class="net-cell">${dailyNet.reduce((a,b)=>a+b,0).toFixed(1)}</td></tr>`;

  html += `<tr style="background:#d4edda">
    <td class="fixed" colspan="5"><b>Monthly Net Saleable (L)</b></td>
    <td colspan="${days*2}"></td>
    <td class="net-cell"><b>${(grossMonthly - (totalDedAM + totalDedPM)).toFixed(1)}</b></td></tr>`;

  document.querySelector("tbody").insertAdjacentHTML("beforeend", html);
}

// ──────────────────────────────────────────────
// NEW: Save as JSON button
// ──────────────────────────────────────────────

function saveAsJson() {
  const exportData = {
    cows: cows,
    dairyData: state,
    lastSaved: new Date().toISOString(),
    version: "1.0"
  };

  const jsonString = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `dairy_data_${month}_${year}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ──────────────────────────────────────────────
// OTHER FUNCTIONS (unchanged)
// ──────────────────────────────────────────────

function updateProd(i, d, type, val) {
  const key = getKey();
  if (state[key]?.prod?.[i]) {
    state[key].prod[i][type][d] = val;
    save(); render();
  }
}

function updateDed(d, type, val) {
  const key = getKey();
  if (state[key]?.deductions?.[type] !== undefined) {
    state[key].deductions[type][d] = val;
    save(); render();
  }
}

function toggleHide(i) {
  const key = getKey();
  if (state[key]?.hidden) {
    state[key].hidden[i] = !state[key].hidden[i];
    save(); render();
  }
}

function save() {
  localStorage.setItem("cowList", JSON.stringify(cows));
  localStorage.setItem("dairyData", JSON.stringify(state));
}

function addNewCow() {
  const no   = document.getElementById("newNo").value.trim();
  const name = document.getElementById("newName").value.trim().toUpperCase();
  const calv = document.getElementById("newCalving").value;
  const preg = document.getElementById("newPreg").value.trim();

  if (!no || !name) { alert("Tag/No and Name are required."); return; }

  cows.push({ no, name, calving: calv || "", preg: preg || "" });

  Object.keys(state).forEach(key => {
    const days = state[key].prod?.[0]?.am?.length || 31;
    state[key].prod?.push({ am: Array(days).fill(""), pm: Array(days).fill("") });
    state[key].hidden?.push(false);
  });

  save(); render();

  document.getElementById("newNo").value = "";
  document.getElementById("newName").value = "";
  document.getElementById("newCalving").value = "";
  document.getElementById("newPreg").value = "";
}

function deleteCow(index) {
  const cow = cows[index];
  if (!cow) return;
  if (!confirm(`Delete cow ${cow.no} ${cow.name}?`)) return;

  cows.splice(index, 1);

  Object.keys(state).forEach(key => {
    if (state[key].prod?.length > index) {
      state[key].prod.splice(index, 1);
      state[key].hidden.splice(index, 1);
    }
  });

  save(); render();
}

function unhideAll() {
  const data = initMonth();
  data.hidden.fill(false);
  save(); render();
}

function editCow(index, cell, field) {
  const current = cows[index]?.[field] ?? "";
  let inputHtml;

  if (field === "calving") {
    inputHtml = `<input type="date" value="${current}" onblur="saveCowEdit(${index}, '${field}', this.value)" onkeydown="if(event.key==='Enter')this.blur()">`;
  } else {
    const width = (field === "name") ? '140' : '90';
    inputHtml = `<input type="text" value="${current}" style="width:${width}px;" onblur="saveCowEdit(${index}, '${field}', this.value)" onkeydown="if(event.key==='Enter')this.blur()">`;
  }

  cell.innerHTML = inputHtml;
  cell.querySelector("input").focus();
}

function saveCowEdit(index, field, value) {
  if (!cows[index]) return;
  value = value.trim();
  if (field === "name") cows[index].name = value.toUpperCase();
  else if (field === "no") cows[index].no = value;
  else if (field === "preg") cows[index].preg = value;
  else if (field === "calving") cows[index].calving = value;
  save(); render();
}

function exportToExcel() {
  const data = initMonth();
  const days = data.prod?.[0]?.am?.length || 31;
  const ws_data = [];
  const header = ["Tag/No", "Name", "Calving", "Preg"];
  for (let d = 1; d <= days; d++) header.push(`${d} AM`, `${d} PM`);
  header.push("Total");
  ws_data.push(header);

  let gross = 0;
  cows.forEach((cow, i) => {
    if (data.hidden?.[i]) return;
    const row = [cow.no || '', cow.name || '', cow.calving || '', cow.preg || ''];
    let tot = 0;
    for (let d = 0; d < days; d++) {
      const a = +data.prod?.[i]?.am?.[d] || 0;
      const p = +data.prod?.[i]?.pm?.[d] || 0;
      row.push(a || "", p || "");
      tot += a + p;
    }
    row.push(tot || "");
    ws_data.push(row);
    gross += tot;
  });

  const dedRow = ["Deductions", "", "", ""];
  let dedTotal = 0;
  for (let d = 0; d < days; d++) {
    const dayDed =
      (+data.deductions?.homeAM?.[d]||0) + (+data.deductions?.workersAM?.[d]||0) + (+data.deductions?.calvesAM?.[d]||0) +
      (+data.deductions?.homePM?.[d]||0) + (+data.deductions?.workersPM?.[d]||0) + (+data.deductions?.calvesPM?.[d]||0);
    dedRow.push(dayDed || "");
    dedTotal += dayDed;
  }
  dedRow.push(dedTotal || "");
  ws_data.push(dedRow);

  ws_data.push(["Net Saleable", "", "", "", ...Array(days*2).fill(""), (gross - dedTotal).toFixed(1)]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, month + "_" + year);
  XLSX.writeFile(wb, `Milk_${month}_${year}.xlsx`);
}

function importJson(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (imported.cows) cows = imported.cows;
      if (imported.dairyData) state = imported.dairyData;
      save(); render();
      alert("Data imported successfully!");
    } catch (err) {
      alert("Invalid JSON file.\n" + err.message);
    }
  };
  reader.readAsText(file);
}

function updateDashboard(days, data) {
  const totals = [];
  cows.forEach((c,i) => {
    if (data.hidden?.[i]) return;
    let t = 0;
    for (let d = 0; d < days; d++) {
      t += (+data.prod?.[i]?.am?.[d]||0) + (+data.prod?.[i]?.pm?.[d]||0);
    }
    totals.push({name: c.name, total: t});
  });
  totals.sort((a,b) => b.total - a.total);

  document.getElementById("topList").innerHTML = totals.slice(0,5).map(c=>`<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");
  document.getElementById("lowList").innerHTML = totals.slice(-5).reverse().map(c=>`<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("yearSel").value = year;
  document.getElementById("monthSel").value = month;

  document.getElementById("yearSel").onchange = e => { year = +e.target.value; render(); };
  document.getElementById("monthSel").onchange = e => { month = e.target.value; render(); };

  document.getElementById("importJson").onchange = e => {
    if (e.target.files[0]) importJson(e.target.files[0]);
  };

  render();
});
</script>
</body>
</html>
