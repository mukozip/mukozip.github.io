<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dairy Farm Milk Record - Mukozi</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        h1 {
            color: #2c3e50;
        }
        .controls {
            margin: 20px 0;
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: inline-block;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: center;
            font-size: 0.92em;
        }
        th {
            background: #3498db;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td:first-child {
            text-align: left;
            font-weight: bold;
            background: #f1f5f9;
        }
        input[type="number"] {
            width: 60px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .hiddenRow {
            display: none;
        }
        button {
            padding: 4px 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #c0392b;
        }
        #stats {
            margin-top: 25px;
            padding: 15px;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        #topList, #lowList {
            columns: 2;
            margin: 10px 0;
        }
        .deduction-cell {
            background: #fff3cd;
            font-size: 0.9em;
        }
        .net-cell {
            background: #d4edda;
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>
<body>

<h1>Dairy Milk Record</h1>

<div class="controls">
    <label>Year: 
        <select id="yearSel">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
        </select>
    </label>
       
    <label>Month: 
        <select id="monthSel">
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December" selected>December</option>
        </select>
    </label>
</div>

<table id="milkTable">
    <thead>
        <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
</table>

<div id="stats">
    <h3>Quick Stats</h3>
    <p>Top 5 cows:</p>
    <ul id="topList"></ul>
    <p>Bottom 5 cows:</p>
    <ul id="lowList"></ul>
</div>

<script>
// ========================
// DATA
// ========================

const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

let cows = JSON.parse(localStorage.getItem("cowList")) || [
    {no:"093", name:"RITAH",   calving:"2024-05-28", preg:""},
    {no:"434", name:"SHANA",   calving:"2024-10-06", preg:"1.6"},
    {no:"083", name:"KATHY",   calving:"2024-10-27", preg:""},
    {no:"402", name:"KELLEN",  calving:"2024-11-13", preg:""},
    {no:"098", name:"JACKLINE",calving:"2025-04-12", preg:"0"},
    {no:"421", name:"EVA",     calving:"2025-05-17", preg:"0"},
    {no:"099", name:"SARAH",   calving:"2025-04-20", preg:"0"},
    {no:"521", name:"KEZA",    calving:"2025-03-11", preg:"0"},
    {no:"539", name:"KIRABO",  calving:"2025-04-25", preg:"0"},
    {no:"403", name:"PEACE",   calving:"2025-05-10", preg:"0"},
    {no:"418", name:"IRENE",   calving:"2025-05-17", preg:"0"},
    {no:"296", name:"JOAN",    calving:"2025-05-28", preg:"0"},
    {no:"511", name:"SIIMA",   calving:"2025-06-22", preg:"0"},
    {no:"021", name:"BIIRA",   calving:"2025-06-24", preg:"0"},
    {no:"502", name:"RUTH",    calving:"2024-07-07", preg:"0"},
    {no:"010", name:"DEBRA",   calving:"2025-07-08", preg:"0"},
    {no:"516", name:"NAKATO",  calving:"2025-07-19", preg:"0"},
    {no:"535", name:"FIONA",   calving:"2025-07-21", preg:"0"},
    {no:"134", name:"BEATRICE",calving:"2025-08-02", preg:"0"},
    {no:"011", name:"NINA",    calving:"2025-08-04", preg:"0"},
    {no:"100", name:"KARUNGI", calving:"2025-07-09", preg:"0"},
    {no:"935", name:"PROSSY",  calving:"2025-08-23", preg:"0"},
    {no:"404", name:"KYOOZI",  calving:"2025-08-28", preg:"0"},
    {no:"013", name:"BELLA",   calving:"2025-09-05", preg:"0"},
    {no:"425", name:"ANGEL",   calving:"2025-11-02", preg:"0"},
    {no:"297", name:"MERCY",   calving:"2025-11-30", preg:"0"}
];

let year = 2026;
let month = "January";
let state = JSON.parse(localStorage.getItem("dairyData")) || {};

// ========================
// CORE FUNCTIONS
// ========================

function getKey() {
    return year + "_" + month;
}

function initMonth() {
    const key = getKey();
    if (!state[key]) {
        const days = new Date(year, MONTHS.indexOf(month) + 1, 0).getDate();
        state[key] = {
            prod: cows.map(() => ({
                am: Array(days).fill(""),
                pm: Array(days).fill("")
            })),
            deductions: {
                home:    Array(days).fill(""),
                workers: Array(days).fill(""),
                calvesAM: Array(days).fill(""),
                calvesPM: Array(days).fill("")
            },
            hidden: Array(cows.length).fill(false)
        };
    }
    return state[key];
}

// ========================
// RENDER
// ========================

function render() {
    const data = initMonth();
    const days = data.prod[0].am.length;

    document.getElementById("caption")?.remove(); // just in case
    document.querySelector("h1").insertAdjacentHTML("afterend",
        `<h2 id="caption" style="margin-top:0">${month} ${year}</h2>`
    );

    // Header
    let header = "<th>Cow</th><th>Calving</th><th>Preg</th><th>Hide</th>";
    for (let d = 1; d <= days; d++) {
        header += `<th>${d}<br>AM</th><th>${d}<br>PM</th>`;
    }
    header += "<th>Total (L)</th>";
    document.getElementById("headerRow").innerHTML = header;

    // Body
    let body = "";
    let grossMonthly = 0;

    cows.forEach((cow, i) => {
        const hidden = data.hidden[i];
        let row = `<tr class="${hidden ? 'hiddenRow' : ''}">
            <td>${cow.no} ${cow.name}</td>
            <td>${cow.calving || '-'}</td>
            <td>${cow.preg || '-'}</td>
            <td><button onclick="toggleHide(${i})">${hidden ? 'Show' : 'Hide'}</button></td>`;

        let total = 0;

        for (let d = 0; d < days; d++) {
            const am = data.prod[i].am[d] || "";
            const pm = data.prod[i].pm[d] || "";
            if (!hidden) total += (+am || 0) + (+pm || 0);

            row += `
                <td><input type="number" step="0.1" value="${am}" onchange="updateProd(${i},${d},'am',this.value)"></td>
                <td><input type="number" step="0.1" value="${pm}" onchange="updateProd(${i},${d},'pm',this.value)"></td>`;
        }

        grossMonthly += total;
        row += `<td>${total ? total.toFixed(1) : '-'}</td></tr>`;
        body += row;
    });

    document.querySelector("tbody").innerHTML = body;

    renderDeductions(days, data, grossMonthly);
    updateDashboard(days, data);
}

function renderDeductions(days, data, gross) {
    let row = `<tr style="background:#fff3cd">
        <td colspan="4"><b>Deductions</b></td>`;

    let totalDed = 0;

    for (let d = 0; d < days; d++) {
        const home     = +data.deductions.home[d]    || 0;
        const workers  = +data.deductions.workers[d] || 0;
        const calvesAM = +data.deductions.calvesAM[d]|| 0;
        const calvesPM = +data.deductions.calvesPM[d]|| 0;

        const dayDed = home + workers + calvesAM + calvesPM;
        totalDed += dayDed;

        row += `
            <td class="deduction-cell">
                Home: <input type="number" step="0.1" value="${home}" onchange="updateDed(${d},'home',this.value)"><br>
                Workers: <input type="number" step="0.1" value="${workers}" onchange="updateDed(${d},'workers',this.value)"><br>
                Calf AM: <input type="number" step="0.1" value="${calvesAM}" onchange="updateDed(${d},'calvesAM',this.value)"><br>
                Calf PM: <input type="number" step="0.1" value="${calvesPM}" onchange="updateDed(${d},'calvesPM',this.value)">
            </td>
            <td></td>`;
    }

    row += `<td class="net-cell">${totalDed.toFixed(1)}</td></tr>`;

    const net = gross - totalDed;
    row += `<tr style="background:#d4edda">
        <td colspan="4"><b>Net Saleable (L)</b></td>
        <td colspan="${days*2}"></td>
        <td class="net-cell"><b>${net.toFixed(1)}</b></td>
    </tr>`;

    // Insert deductions row after the last cow row
    const tbody = document.querySelector("tbody");
    tbody.insertAdjacentHTML("beforeend", row);
}

function updateDashboard(days, data) {
    const totals = [];

    cows.forEach((cow, i) => {
        if (data.hidden[i]) return;
        let total = 0;
        for (let d = 0; d < days; d++) {
            total += (+data.prod[i].am[d] || 0) + (+data.prod[i].pm[d] || 0);
        }
        totals.push({ name: cow.name, total });
    });

    totals.sort((a,b) => b.total - a.total);

    document.getElementById("topList").innerHTML =
        totals.slice(0,5).map(c => `<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");

    document.getElementById("lowList").innerHTML =
        totals.slice(-5).reverse().map(c => `<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");
}

// ========================
// UPDATE & SAVE
// ========================

function updateProd(i, d, type, val) {
    state[getKey()].prod[i][type][d] = val;
    save();
    render();
}

function updateDed(d, type, val) {
    state[getKey()].deductions[type][d] = val;
    save();
    render();
}

function toggleHide(i) {
    state[getKey()].hidden[i] = !state[getKey()].hidden[i];
    save();
    render();
}

function save() {
    localStorage.setItem("dairyData", JSON.stringify(state));
    localStorage.setItem("cowList", JSON.stringify(cows));
}

// ========================
// EVENT LISTENERS
// ========================

document.addEventListener("DOMContentLoaded", () => {
    const yearSelect = document.getElementById("yearSel");
    const monthSelect = document.getElementById("monthSel");

    yearSelect.value = year;
    monthSelect.value = month;

    yearSelect.onchange = e => {
        year = +e.target.value;
        render();
    };

    monthSelect.onchange = e => {
        month = e.target.value;
        render();
    };

    // Initial render
    render();
});
</script>

</body>
</html>
