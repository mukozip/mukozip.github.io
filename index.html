<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dairy Records • One row per cow</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 1rem;
      line-height: 1.5;
    }
    h1 { margin-bottom: 0.6rem; }
    .controls, .add-cow { margin: 1rem 0; display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: center; }
    button, input[type="button"] {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .add    { background: #28a745; color: white; border: none; }
    .save   { background: #007bff; color: white; border: none; }
    .load   { background: #6c757d; color: white; border: none; }
    .export { background: #6f42c1; color: white; border: none; }
    .hide   { background: #fd7e14; font-size: 0.9em; padding: 0.3rem 0.6rem; }
    table {
      border-collapse: collapse;
      font-size: 0.92rem;
      width: 100%;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px 6px;
      text-align: center;
      min-width: 38px;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 2;
      min-width: 160px;
      text-align: left;
    }
    thead th {
      background: #e9ecef;
      position: sticky;
      top: 0;
      z-index: 3;
    }
    tfoot td {
      background: #f1f3f5;
      font-weight: bold;
    }
    tfoot tr:nth-child(1) { background: #d4edda; } /* Daily Total    - light green */
    tfoot tr:nth-child(6) { background: #fff3cd; } /* Final Total    - light yellow */
    input[type=number] {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      border: 1px solid #aaa;
      padding: 2px;
    }
    .cow-name { font-weight: 600; }
    .msg { color: #155724; background: #d4edda; padding: 8px; border-radius: 4px; margin: 0.8rem 0; }
  </style>
</head>
<body>

<h1>Dairy Records • One row per cow</h1>

<!-- Add new cow form -->
<div class="add-cow">
  <input type="text" id="newNo" placeholder="Cow No" size="8">
  <input type="text" id="newName" placeholder="Name / Display" size="18">
  <input type="date" id="newCalving" title="Last calving date">
  <input type="number" step="0.1" id="newPreg" placeholder="Preg months" size="6">
  <button class="add" onclick="addNewCow()">Add Cow</button>
</div>

<div class="controls">
  <label>Month:
    <select id="selMonth">
      <option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option>
      <option selected>July</option>
      <option>August</option><option>September</option><option>October</option>
      <option>November</option><option>December</option>
    </select>
  </label>

  <button class="save"   onclick="saveCurrentMonth()">Save Data</button>
  <button class="load"   onclick="loadCurrentMonth()">Load Data</button>
  <button class="export" onclick="exportToExcel()">Export to Excel</button>
  <button onclick="showExcludedCows()">Show / Restore excluded cows</button>
  <button onclick="if(confirm('Reset ALL data?')){localStorage.clear();location.reload()}">Reset Everything</button>
</div>

<div id="msg" class="msg"></div>

<div class="table-container">
  <table id="tbl">
    <caption id="cap">July 2025 — Milk Production & Deductions</caption>
    <thead>
      <tr>
        <th>Cow</th>
        <th>Calving Date</th>
        <th>Preg. Months</th>
        <!-- Day 1 AM / PM, Day 2 AM / PM, ... will be inserted here -->
        <th>Total</th>
        <th>Hide</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr id="daily"><td>Daily Total</td><td></td><td></td></tr>
      <tr id="home"><td>Home Use</td><td></td><td></td></tr>
      <tr id="work"><td>Workers Milk</td><td></td><td></td></tr>
      <tr id="calfAM"><td>Calves Milk AM</td><td></td><td></td></tr>
      <tr id="calfPM"><td>Calves Milk PM</td><td></td><td></td></tr>
      <tr id="final"><td><b>Final Total</b></td><td></td><td></td></tr>
    </tfoot>
  </table>
</div>

<script>
// ──────────────────────────────────────────────
// DATA — exactly the 26 cows from your JSON
// ──────────────────────────────────────────────

const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const YEAR = 2025;

let cows = [
  {no:"093", name:"1. RITAH",   calving:"2024-05-28", preg:""},
  {no:"434", name:"2. SHANA",   calving:"2024-10-06", preg:"1.6"},
  {no:"083", name:"3. KATHY",   calving:"2024-10-27", preg:""},
  {no:"402", name:"4. KELLEN",  calving:"2024-11-13", preg:""},
  {no:"098", name:"5. Jackline",calving:"2025-04-12", preg:"0"},
  {no:"421", name:"6. Eva",     calving:"2025-05-17", preg:"0"},
  {no:"099", name:"7. Sarah",   calving:"2025-04-20", preg:"0"},
  {no:"521", name:"8. Keza",    calving:"2025-03-11", preg:"0"},
  {no:"539", name:"9. Kirabo",  calving:"2025-04-25", preg:"0"},
  {no:"403", name:"10. Peace",  calving:"2025-05-10", preg:"0"},
  {no:"418", name:"11. Irene",  calving:"2025-05-17", preg:"0"},
  {no:"296", name:"12. Joan",   calving:"2025-05-28", preg:"0"},
  {no:"511", name:"13. Siima",  calving:"2025-06-22", preg:"0"},
  {no:"021", name:"14. Biira",  calving:"2025-06-24", preg:"0"},
  {no:"502", name:"15. Ruth",   calving:"2024-07-07", preg:"0"},
  {no:"010", name:"16. Debra",  calving:"2025-07-08", preg:"0"},
  {no:"516", name:"17. Nakato", calving:"2025-07-19", preg:"0"},
  {no:"535", name:"18. Fiona",  calving:"2025-07-21", preg:"0"},
  {no:"134", name:"19. Beatrice",calving:"2025-08-02",preg:"0"},
  {no:"011", name:"20. Nina",   calving:"2025-08-04", preg:"0"},
  {no:"100", name:"21. Karungi",calving:"2025-07-09", preg:"0"},
  {no:"935", name:"22. Prossy", calving:"2025-08-23", preg:"0"},
  {no:"404", name:"23. Kyoozi", calving:"2025-08-28", preg:"0"},
  {no:"013", name:"24. Bella",  calving:"2025-09-05", preg:"0"},
  {no:"425", name:"25. Angel",  calving:"2025-11-02", preg:"0"},
  {no:"297", name:"26. Mercy",  calving:"2025-11-30", preg:"0"}
];

let state = JSON.parse(localStorage.getItem("dairyState")) || {};

// Initialize missing months
MONTHS.forEach(m => {
  if (!state[m]) {
    const days = new Date(YEAR, MONTHS.indexOf(m)+1, 0).getDate();
    state[m] = {
      cows: cows.map(c => ({...c, hidden: false})),
      production: cows.map(() => ({am: Array(days).fill(""), pm: Array(days).fill("")})),
      deductions: {
        homeUse:    Array(days).fill(""),
        workersMilk: Array(days).fill(""),
        calvesAM:   Array(days).fill(""),
        calvesPM:   Array(days).fill("")
      }
    };
  }
});

let currentMonth = "July";

// ──────────────────────────────────────────────
// RENDER
// ──────────────────────────────────────────────

function render() {
  const month = currentMonth;
  const days  = new Date(YEAR, MONTHS.indexOf(month)+1, 0).getDate();
  const data  = state[month];

  document.getElementById("selMonth").value = month;
  document.getElementById("cap").textContent = `${month} ${YEAR} — Milk Production & Deductions`;

  const thead = document.querySelector("#tbl thead tr");
  thead.innerHTML = `
    <th>Cow</th>
    <th>Calving Date</th>
    <th>Preg. Months</th>
  `;
  for (let d = 1; d <= days; d++) {
    thead.innerHTML += `<th>Day ${d}<br>AM</th><th>Day ${d}<br>PM</th>`;
  }
  thead.innerHTML += `<th>Total</th><th>Hide</th>`;

  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  data.cows.forEach((cow, i) => {
    if (cow.hidden) return;

    const prod = data.production[i] || {am:Array(days).fill(""), pm:Array(days).fill("")};
    let total = 0;
    let row = `
      <tr>
        <td class="cow-name">[${cow.no}] ${cow.name}</td>
        <td>${cow.calving}</td>
        <td>${cow.preg}</td>
    `;

    for (let d = 0; d < days; d++) {
      const amVal = prod.am[d] || "";
      const pmVal = prod.pm[d] || "";
      const daySum = (parseFloat(amVal)||0) + (parseFloat(pmVal)||0);
      total += daySum;

      row += `
        <td><input type="number" step="0.1" value="${amVal}" data-i="${i}" data-d="${d}" data-type="am"></td>
        <td><input type="number" step="0.1" value="${pmVal}" data-i="${i}" data-d="${d}" data-type="pm"></td>
      `;
    }

    row += `
      <td><b>${total.toFixed(1)}</b></td>
      <td><button class="hide" onclick="toggleHide(${i})">Hide</button></td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  updateFooterTotals();

  document.querySelectorAll('input[type=number]').forEach(el => {
    el.addEventListener('input', handleInputChange);
  });
}

function handleInputChange(e) {
  const {i, d, type} = e.target.dataset;
  const val = e.target.value;
  state[currentMonth].production[i][type][d] = val;
  updateFooterTotals();
}

function updateFooterTotals() {
  const monthData = state[currentMonth];
  const days = monthData.production[0]?.am.length || 31;

  let daily = Array(days).fill(0);
  let home = 0, work = 0, calfAM = 0, calfPM = 0;

  monthData.cows.forEach((cow, i) => {
    if (cow.hidden) return;
    const prod = monthData.production[i];
    for (let d = 0; d < days; d++) {
      daily[d] += (parseFloat(prod.am[d])||0) + (parseFloat(prod.pm[d])||0);
    }
  });

  monthData.deductions.homeUse.forEach(v => home += parseFloat(v)||0);
  monthData.deductions.workersMilk.forEach(v => work += parseFloat(v)||0);
  monthData.deductions.calvesAM.forEach(v => calfAM += parseFloat(v)||0);
  monthData.deductions.calvesPM.forEach(v => calfPM += parseFloat(v)||0);

  const totalDeduct = home + work + calfAM + calfPM;
  const grandTotal = daily.reduce((a,b)=>a+b,0) - totalDeduct;

  const dailyRow = document.getElementById("daily");
  dailyRow.innerHTML = "<td>Daily Total</td><td></td><td></td>";
  daily.forEach(v => dailyRow.innerHTML += `<td>${v.toFixed(1)}</td>`);
  dailyRow.innerHTML += `<td>${daily.reduce((a,b)=>a+b,0).toFixed(1)}</td><td></td>`;

  document.getElementById("home").innerHTML = `<td>Home Use</td><td></td><td></td>` + Array(days).fill().map(()=>`<td></td>`).join("") + `<td>${home.toFixed(1)}</td><td></td>`;
  document.getElementById("work").innerHTML = `<td>Workers Milk</td><td></td><td></td>` + Array(days).fill().map(()=>`<td></td>`).join("") + `<td>${work.toFixed(1)}</td><td></td>`;
  document.getElementById("calfAM").innerHTML = `<td>Calves Milk AM</td><td></td><td></td>` + Array(days).fill().map(()=>`<td></td>`).join("") + `<td>${calfAM.toFixed(1)}</td><td></td>`;
  document.getElementById("calfPM").innerHTML = `<td>Calves Milk PM</td><td></td><td></td>` + Array(days).fill().map(()=>`<td></td>`).join("") + `<td>${calfPM.toFixed(1)}</td><td></td>`;
  document.getElementById("final").innerHTML = `<td><b>Final Total</b></td><td></td><td></td>` + Array(days).fill().map(()=>`<td></td>`).join("") + `<td><b>${grandTotal.toFixed(1)}</b></td><td></td>`;
}

// ──────────────────────────────────────────────
// ACTIONS
// ──────────────────────────────────────────────

function addNewCow() {
  const no   = document.getElementById("newNo").value.trim();
  const name = document.getElementById("newName").value.trim();
  const calv = document.getElementById("newCalving").value;
  const preg = document.getElementById("newPreg").value.trim();

  if (!no || !name || !calv) {
    alert("Cow No, Name and Calving Date are required.");
    return;
  }

  if (cows.some(c => c.no === no)) {
    alert("Cow number already exists.");
    return;
  }

  const newCow = {no, name, calving: calv, preg: preg || "0"};
  cows.push(newCow);

  MONTHS.forEach(m => {
    const days = new Date(YEAR, MONTHS.indexOf(m)+1, 0).getDate();
    state[m].cows.push({...newCow, hidden: false});
    state[m].production.push({am: Array(days).fill(""), pm: Array(days).fill("")});
  });

  save();
  render();

  // Clear form
  document.getElementById("newNo").value = "";
  document.getElementById("newName").value = "";
  document.getElementById("newCalving").value = "";
  document.getElementById("newPreg").value = "";

  alert(`Cow ${name} (${no}) added to all months.`);
}

function toggleHide(idx) {
  state[currentMonth].cows[idx].hidden = !state[currentMonth].cows[idx].hidden;
  save();
  render();
}

function showExcludedCows() {
  const hidden = state[currentMonth].cows.filter(c => c.hidden).map(c => c.name);
  if (hidden.length === 0) return alert("No cows are hidden this month.");
  if (confirm(`Restore ${hidden.length} hidden cow(s)?\n\n${hidden.join("\n")}`)) {
    state[currentMonth].cows.forEach(c => c.hidden = false);
    save();
    render();
  }
}

function saveCurrentMonth() {
  save();
  document.getElementById("msg").textContent = "Data saved ✓";
  setTimeout(() => document.getElementById("msg").textContent = "", 2400);
}

function loadCurrentMonth() {
  render();
  document.getElementById("msg").textContent = "Data loaded";
  setTimeout(() => document.getElementById("msg").textContent = "", 2400);
}

function save() {
  localStorage.setItem("dairyState", JSON.stringify(state));
}

function exportToExcel() {
  const wb = XLSX.utils.book_new();

  MONTHS.forEach(m => {
    const d = state[m];
    const days = d.production[0]?.am.length || 31;

    let wsData = [
      ["Cow", "Calving Date", "Preg. Months", ...Array.from({length:days}, (_,i)=>`Day ${i+1} AM`), ...Array.from({length:days}, (_,i)=>`Day ${i+1} PM`), "Total"]
    ];

    d.cows.forEach((cow, i) => {
      if (cow.hidden) return;
      const row = [cow.name, cow.calving, cow.preg];
      let total = 0;
      for (let day = 0; day < days; day++) {
        const am = parseFloat(d.production[i].am[day]) || 0;
        const pm = parseFloat(d.production[i].pm[day]) || 0;
        row.push(am, pm);
        total += am + pm;
      }
      row.push(total);
      wsData.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, m);
  });

  XLSX.writeFile(wb, `Dairy_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ──────────────────────────────────────────────
// INIT
// ──────────────────────────────────────────────

document.getElementById("selMonth").addEventListener("change", e => {
  currentMonth = e.target.value;
  render();
});

render();
  </script>
</body>
</html>
