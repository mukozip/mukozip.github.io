<script>

// ========================
// MASTER COW LIST
// ========================

let cows = JSON.parse(localStorage.getItem("cowList")) || [
{no:"093",name:"RITAH",calving:"2024-05-28",preg:""},
{no:"434",name:"SHANA",calving:"2024-10-06",preg:"1.6"},
{no:"083",name:"KATHY",calving:"2024-10-27",preg:""},
{no:"402",name:"KELLEN",calving:"2024-11-13",preg:""},
{no:"098",name:"JACKLINE",calving:"2025-04-12",preg:"0"},
{no:"421",name:"EVA",calving:"2025-05-17",preg:"0"},
{no:"099",name:"SARAH",calving:"2025-04-20",preg:"0"},
{no:"521",name:"KEZA",calving:"2025-03-11",preg:"0"},
{no:"539",name:"KIRABO",calving:"2025-04-25",preg:"0"},
{no:"403",name:"PEACE",calving:"2025-05-10",preg:"0"},
{no:"418",name:"IRENE",calving:"2025-05-17",preg:"0"},
{no:"296",name:"JOAN",calving:"2025-05-28",preg:"0"},
{no:"511",name:"SIIMA",calving:"2025-06-22",preg:"0"},
{no:"021",name:"BIIRA",calving:"2025-06-24",preg:"0"},
{no:"502",name:"RUTH",calving:"2024-07-07",preg:"0"},
{no:"010",name:"DEBRA",calving:"2025-07-08",preg:"0"},
{no:"516",name:"NAKATO",calving:"2025-07-19",preg:"0"},
{no:"535",name:"FIONA",calving:"2025-07-21",preg:"0"},
{no:"134",name:"BEATRICE",calving:"2025-08-02",preg:"0"},
{no:"011",name:"NINA",calving:"2025-08-04",preg:"0"},
{no:"100",name:"KARUNGI",calving:"2025-07-09",preg:"0"},
{no:"935",name:"PROSSY",calving:"2025-08-23",preg:"0"},
{no:"404",name:"KYOOZI",calving:"2025-08-28",preg:"0"},
{no:"013",name:"BELLA",calving:"2025-09-05",preg:"0"},
{no:"425",name:"ANGEL",calving:"2025-11-02",preg:"0"},
{no:"297",name:"MERCY",calving:"2025-11-30",preg:"0"}
];

// ========================
// CORE
// ========================

const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
let year=2026;
let month="January";
let state=JSON.parse(localStorage.getItem("dairyData"))||{};

function getKey(){ return year+"_"+month }

function initMonth(){
const key=getKey();
if(!state[key]){
const days=new Date(year,MONTHS.indexOf(month)+1,0).getDate();
state[key]={
prod:cows.map(()=>({am:Array(days).fill(""),pm:Array(days).fill("")})),
deductions:{
home:Array(days).fill(""),
workers:Array(days).fill(""),
calvesAM:Array(days).fill(""),
calvesPM:Array(days).fill("")
},
hidden:Array(cows.length).fill(false)
};
}
return state[key];
}

// ========================
// RENDER
// ========================

function render(){
const data=initMonth();
const days=data.prod[0].am.length;
document.getElementById("caption").innerText=month+" "+year;

let header="<th>Cow</th><th>Calving</th><th>Preg</th><th>Hide</th>";
for(let d=1;d<=days;d++){
header+=`<th>${d}<br>AM</th><th>${d}<br>PM</th>`;
}
header+="<th>Total</th>";
document.getElementById("headerRow").innerHTML=header;

let body="";
let grossMonthly=0;

cows.forEach((cow,i)=>{
let hidden=data.hidden[i];
let row=`<tr class="${hidden?'hiddenRow':''}">
<td>${cow.no} ${cow.name}</td>
<td>${cow.calving}</td>
<td>${cow.preg}</td>
<td><button onclick="toggleHide(${i})">${hidden?'Show':'Hide'}</button></td>`;

let total=0;

for(let d=0;d<days;d++){
let am=data.prod[i].am[d]||"";
let pm=data.prod[i].pm[d]||"";
if(!hidden) total+=(+am||0)+(+pm||0);

row+=`<td><input type="number" value="${am}" onchange="updateProd(${i},${d},'am',this.value)"></td>
<td><input type="number" value="${pm}" onchange="updateProd(${i},${d},'pm',this.value)"></td>`;
}
grossMonthly+=total;
row+=`<td>${total.toFixed(1)}</td></tr>`;
body+=row;
});

document.querySelector("tbody").innerHTML=body;

renderDeductions(days,data,grossMonthly);
updateDashboard(days,data);
}

// ========================
// DEDUCTIONS RENDER
// ========================

function renderDeductions(days,data,gross){

let row="<tr style='background:#fff3cd'><td><b>Deductions</b></td><td></td><td></td><td></td>";

let totalDed=0;

for(let d=0;d<days;d++){
let home=+data.deductions.home[d]||0;
let workers=+data.deductions.workers[d]||0;
let calvesAM=+data.deductions.calvesAM[d]||0;
let calvesPM=+data.deductions.calvesPM[d]||0;

let dayDed=home+workers+calvesAM+calvesPM;
totalDed+=dayDed;

row+=`
<td>
Home:<input type="number" value="${home}" onchange="updateDed(${d},'home',this.value)">
Workers:<input type="number" value="${workers}" onchange="updateDed(${d},'workers',this.value)">
CalfAM:<input type="number" value="${calvesAM}" onchange="updateDed(${d},'calvesAM',this.value)">
CalfPM:<input type="number" value="${calvesPM}" onchange="updateDed(${d},'calvesPM',this.value)">
</td>
<td></td>`;
}

row+=`<td>${totalDed.toFixed(1)}</td></tr>`;

let net=gross-totalDed;

row+=`<tr style="background:#d4edda">
<td><b>Net Saleable</b></td><td></td><td></td><td></td>
<td colspan="${days*2}"></td>
<td><b>${net.toFixed(1)}</b></td>
</tr>`;

document.getElementById("dailyRow").innerHTML=row;
}

// ========================
// UPDATE
// ========================

function updateProd(i,d,type,val){
state[getKey()].prod[i][type][d]=val;
save(); render();
}

function updateDed(d,type,val){
state[getKey()].deductions[type][d]=val;
save(); render();
}

function toggleHide(i){
state[getKey()].hidden[i]=!state[getKey()].hidden[i];
save(); render();
}

// ========================
// DASHBOARD
// ========================

function updateDashboard(days,data){

let totals=[];

cows.forEach((cow,i)=>{
if(data.hidden[i]) return;
let total=0;
for(let d=0;d<days;d++){
total+=(+data.prod[i].am[d]||0)+(+data.prod[i].pm[d]||0);
}
totals.push({name:cow.name,total});
});

totals.sort((a,b)=>b.total-a.total);

document.getElementById("topList").innerHTML=
totals.slice(0,5).map(c=>`<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");

document.getElementById("lowList").innerHTML=
totals.slice(-5).reverse().map(c=>`<li>${c.name} — ${c.total.toFixed(1)} L</li>`).join("");
}

// ========================
// SAVE
// ========================

function save(){
localStorage.setItem("dairyData",JSON.stringify(state));
localStorage.setItem("cowList",JSON.stringify(cows));
}

yearSel.onchange=e=>{year=+e.target.value;render();}
monthSel.onchange=e=>{month=e.target.value;render();}

render();

</script>
