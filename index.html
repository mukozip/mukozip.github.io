<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Management App</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 8px;
            font-size: 10px;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            position: relative;
        }
        table {
            border-collapse: collapse;
            width: auto;
            margin-top: 8px;
        }
        th, td {
            border: 1px solid black;
            padding: 3px;
            text-align: center;
            min-width: 30px;
            font-size: 10px;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:nth-child(1), td:nth-child(1) {
            position: sticky;
            left: 0;
            background-color: #e0e0e0;
            z-index: 11;
            min-width: 100px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        th:nth-child(2), td:nth-child(2) {
            position: sticky;
            left: 100px;
            background-color: #e0e0e0;
            z-index: 11;
            min-width: 30px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        th:nth-child(n+3), td:nth-child(n+3) {
            background-color: #ffffff;
        }
        input[type="number"] {
            width: 30px;
            padding: 2px;
            font-size: 10px;
        }
        input[type="text"], input[type="date"] {
            padding: 2px;
            margin: 2px;
            width: 100px;
            font-size: 10px;
        }
        input[type="file"] {
            margin: 2px;
            font-size: 10px;
        }
        button {
            padding: 4px 8px;
            margin: 2px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.delete {
            background-color: #f44336;
        }
        button.delete:hover {
            background-color: #da190b;
        }
        .form-container {
            margin-bottom: 8px;
            background-color: #f9f9f9;
            padding: 6px;
            border-radius: 3px;
        }
        .message {
            color: green;
            margin: 4px 0;
            font-size: 10px;
        }
        .ranking-section {
            margin-top: 12px;
        }
        .ranking-table {
            width: 50%;
            margin-bottom: 8px;
        }
        .ranking-table th {
            background-color: #e0e0e0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 12px;
            border: 1px solid #888;
            width: 80%;
            max-width: 350px;
            border-radius: 3px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .highlight-row {
            background-color: #fff9c4;
        }
    </style>
</head>
<body>
    <h1 style="font-size: 14px;">Dairy Management App</h1>
    <p style="font-size: 10px;">Track daily AM/PM milk production and deductions. Edit/delete cows. Data persists via localStorage. Export to CSV/JSON.</p>
    
    <div class="form-container">
        <label for="cowNo">Cow No:</label>
        <input type="text" id="cowNo" required placeholder="e.g., 297">
        <label for="cowName">Cow Name:</label>
        <input type="text" id="cowName" required placeholder="e.g., Mercy">
        <label for="calvingDate">Last Calving:</label>
        <input type="date" id="calvingDate" required>
        <label for="monthsPreg">Preg Months:</label>
        <input type="number" id="monthsPreg" step="0.1" min="0" placeholder="e.g., 3.4">
        <button type="button" onclick="addCowFromForm()">Add Cow</button>
    </div>
    <div id="message" class="message"></div>
    
    <label for="monthSelect">Month:</label>
    <select id="monthSelect" onchange="changeMonth(this.value)">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
    </select>
    <button onclick="saveCurrentMonth()">Save</button>
    <button onclick="exportToCSV()">Export CSV</button>
    <button onclick="exportLocalStorage()">Export Data</button>
    <input type="file" id="importData" accept=".json" onchange="importLocalStorage(event)">
    <button onclick="localStorage.clear(); location.reload();">Reset Data</button>
    
    <div class="table-container">
        <table id="milkTable">
            <caption id="tableCaption">July Records</caption>
            <thead>
                <tr>
                    <th>Cow ID/Name</th>
                    <th>Time</th>
                    <!-- Day columns will be added dynamically -->
                    <th>DAILY TOTAL</th>
                    <th>MONTHLY TOTAL</th>
                    <th>CALVING DATE</th>
                    <th>DAYS SINCE</th>
                    <th>PREG MONTHS</th>
                </tr>
            </thead>
            <tbody>
                <!-- Cows will be added here -->
            </tbody>
            <tfoot>
                <tr id="footerRowAM">
                    <td></td>
                    <td>AM</td>
                    <!-- Day sum cells will be added dynamically -->
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr id="footerRowPM">
                    <td></td>
                    <td>PM</td>
                    <!-- Day sum cells will be added dynamically -->
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="ranking-section">
        <h2 style="font-size: 12px;">Top 5 Milk Producers</h2>
        <table class="ranking-table" id="topDailyTable">
            <caption>Top 5 Daily</caption>
            <thead>
                <tr><th>Day</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="topWeeklyTable">
            <caption>Top 5 Weekly</caption>
            <thead>
                <tr><th>Week</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="topMonthlyTable">
            <caption>Top 5 Monthly</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2 style="font-size: 12px;">Worst 5 Milk Producers</h2>
        <table class="ranking-table" id="worstDailyTable">
            <caption>Worst 5 Daily</caption>
            <thead>
                <tr><th>Day</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="worstWeeklyTable">
            <caption>Worst 5 Weekly</caption>
            <thead>
                <tr><th>Week</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <table class="ranking-table" id="worstMonthlyTable">
            <caption>Worst 5 Monthly</caption>
            <thead>
                <tr><th>Rank</th><th>Cow</th><th>Total (L)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 style="font-size: 12px;">Edit Cow</h2>
            <form id="editCowForm">
                <input type="hidden" id="editCowIndex">
                <label for="editCowNo">Cow No:</label>
                <input type="text" id="editCowNo" required>
                <label for="editCowName">Cow Name:</label>
                <input type="text" id="editCowName" required>
                <label for="editCalvingDate">Last Calving:</label>
                <input type="date" id="editCalvingDate" required>
                <label for="editMonthsPreg">Preg Months:</label>
                <input type="number" id="editMonthsPreg" step="0.1" min="0">
                <button type="button" onclick="saveEditCow()">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        const today = new Date(2025, 7, 14);
        let cowCount = 0;
        let currentMonth = 'July';

        const fixedCowsFromExcel = [
            { cowNo: "297", displayName: "1. MERCY", cowName: "MERCY", calvingDateStr: "2024-03-01", monthsPreg: "4.66666666666667" },
            { cowNo: "413", displayName: "2. MAGRET", cowName: "MAGRET", calvingDateStr: "2024-03-04", monthsPreg: "3.4" },
            { cowNo: "427", displayName: "3. CECE", cowName: "CECE", calvingDateStr: "2024-05-15", monthsPreg: "3.2" },
            { cowNo: "425", displayName: "4. ANGEL", cowName: "ANGEL", calvingDateStr: "2024-05-19", monthsPreg: "5.36666666666667" },
            { cowNo: "093", displayName: "5. RITAH", cowName: "RITAH", calvingDateStr: "2024-05-28", monthsPreg: "" },
            { cowNo: "059", displayName: "6. SUSAN", cowName: "SUSAN", calvingDateStr: "2024-07-24", monthsPreg: "2.1" },
            { cowNo: "008", displayName: "7. FRIDA", cowName: "FRIDA", calvingDateStr: "2024-07-26", monthsPreg: "3.46666666666667" },
            { cowNo: "434", displayName: "8. SHANA", cowName: "SHANA", calvingDateStr: "2024-10-06", monthsPreg: "1.56666666666667" },
            { cowNo: "083", displayName: "9. KATHY", cowName: "KATHY", calvingDateStr: "2024-10-27", monthsPreg: "" },
            { cowNo: "402", displayName: "10. KELLEN", cowName: "KELLEN", calvingDateStr: "2024-11-13", monthsPreg: "" }
        ];

        const initialJulyProductions = [
            { amValues: ["4.5", "4.5", "4.5", "4.5", "5", "", "4.5", "4", "4", "4"], pmValues: ["2", "2", "2", "2", "2", "2", "2", "2", "2", "2"] },
            { amValues: ["5", "5", "5.5", "5", "5.5", "", "6.5", "5.5", "5", "5"], pmValues: ["2.5", "2", "3", "2.5", "2", "2", "2", "2.5", "2.5", "2"] },
            { amValues: ["3.5", "3", "4", "3", "3.5", "", "3.5", "3.5", "3.5", "3"], pmValues: ["1.5", "2", "2", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5", "1.5"] },
            { amValues: ["3.5", "4", "4", "4", "4", "", "4", "4", "4", "3.5"], pmValues: ["2", "2", "2", "2.5", "2", "2", "2", "2", "2", "1.5"] },
            { amValues: ["4.5", "5", "4", "4.5", "4.5", "", "4.5", "5.5", "5", "5.5"], pmValues: ["3", "3", "3", "2.5", "3", "3", "3", "3", "3", "2"] },
            { amValues: ["6", "5.5", "4.5", "5", "4.5", "", "4", "4", "3.5", "3.5"], pmValues: ["2.5", "2.5", "2", "2", "3", "2", "2", "2", "2", "3"] },
            { amValues: ["3.5", "3", "3", "3", "3.5", "", "3", "3.5", "3", "3"], pmValues: Array(10).fill("0") },
            { amValues: ["4.5", "4.5", "4", "4", "4", "", "4", "3.5", "4", "3.5"], pmValues: ["2.5", "2", "2", "2.5", "2", "2", "2", "2", "2", "2"] },
            { amValues: ["4.5", "4", "4", "4", "4", "", "2.5", "4", "2.5", "3"], pmValues: Array(10).fill("0") },
            { amValues: ["7", "6.5", "7", "5", "5", "", "6", "6", "6", "6"], pmValues: ["4", "4.5", "3", "2", "3.5", "4", "3", "2", "2", "2.5"] }
        ];

        let fixedCows = JSON.parse(localStorage.getItem('fixedCows')) || fixedCowsFromExcel;
        let productionData = JSON.parse(localStorage.getItem('productionData')) || {};

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        months.forEach(month => {
            const days = getDaysInMonth(month, 2025);
            if (!productionData[month]) {
                productionData[month] = {
                    productions: fixedCows.map(() => ({
                        amValues: Array(days).fill(''),
                        pmValues: Array(days).fill('')
                    })),
                    deductions: {
                        homeUse: Array(days).fill(''),
                        workersMilk: Array(days).fill(''),
                        calvesMilkAM: Array(days).fill(''),
                        calvesMilkPM: Array(days).fill('')
                    }
                };
            }
            if (month === 'July' && (!productionData['July'].productions || productionData['July'].productions.length === 0)) {
                productionData['July'].productions = JSON.parse(JSON.stringify(initialJulyProductions)).map(prod => ({
                    amValues: prod.amValues.concat(Array(days - prod.amValues.length).fill('')),
                    pmValues: prod.pmValues.concat(Array(days - prod.pmValues.length).fill(''))
                }));
            }
        });

        window.onload = function() {
            sanitizeProductionData();
            cowCount = fixedCows.length;
            document.getElementById('monthSelect').value = currentMonth;
            loadMonth(currentMonth);
        };

        window.onbeforeunload = function() {
            saveCurrentMonth();
            sanitizeProductionData();
            localStorage.setItem('productionData', JSON.stringify(productionData));
        };

        function getDaysInMonth(month, year) {
            const monthIndex = months.indexOf(month);
            return new Date(year, monthIndex + 1, 0).getDate();
        }

        function sanitizeProductionData() {
            const year = 2025;
            months.forEach(month => {
                const days = getDaysInMonth(month, year);
                if (!productionData[month]) {
                    productionData[month] = {
                        productions: fixedCows.map(() => ({
                            amValues: Array(days).fill(''),
                            pmValues: Array(days).fill('')
                        })),
                        deductions: {
                            homeUse: Array(days).fill(''),
                            workersMilk: Array(days).fill(''),
                            calvesMilkAM: Array(days).fill(''),
                            calvesMilkPM: Array(days).fill('')
                        }
                    };
                } else {
                    while (productionData[month].productions.length < fixedCows.length) {
                        productionData[month].productions.push({
                            amValues: Array(days).fill(''),
                            pmValues: Array(days).fill('')
                        });
                    }
                    while (productionData[month].productions.length > fixedCows.length) {
                        productionData[month].productions.pop();
                    }
                    productionData[month].productions.forEach(prod => {
                        prod.amValues = prod.amValues.slice(0, days).concat(Array(Math.max(0, days - prod.amValues.length)).fill(''));
                        prod.pmValues = prod.pmValues.slice(0, days).concat(Array(Math.max(0, days - prod.pmValues.length)).fill(''));
                    });
                    productionData[month].deductions.homeUse = productionData[month].deductions.homeUse?.slice(0, days).concat(Array(Math.max(0, days - (productionData[month].deductions.homeUse?.length || 0))).fill('')) || Array(days).fill('');
                    productionData[month].deductions.workersMilk = productionData[month].deductions.workersMilk?.slice(0, days).concat(Array(Math.max(0, days - (productionData[month].deductions.workersMilk?.length || 0))).fill('')) || Array(days).fill('');
                    productionData[month].deductions.calvesMilkAM = productionData[month].deductions.calvesMilkAM?.slice(0, days).concat(Array(Math.max(0, days - (productionData[month].deductions.calvesMilkAM?.length || 0))).fill('')) || Array(days).fill('');
                    productionData[month].deductions.calvesMilkPM = productionData[month].deductions.calvesMilkPM?.slice(0, days).concat(Array(Math.max(0, days - (productionData[month].deductions.calvesMilkPM?.length || 0))).fill('')) || Array(days).fill('');
                    if (productionData[month].deductions.calvesMilk) {
                        const totalCalves = Array(days).fill('');
                        for (let d = 0; d < days; d++) {
                            const oldCalves = parseFloat(productionData[month].deductions.calvesMilk[d]) || 0;
                            totalCalves[d] = (oldCalves / 2).toFixed(1);
                        }
                        productionData[month].deductions.calvesMilkAM = totalCalves;
                        productionData[month].deductions.calvesMilkPM = totalCalves;
                        delete productionData[month].deductions.calvesMilk;
                    }
                }
            });
            localStorage.setItem('productionData', JSON.stringify(productionData));
        }

        function changeMonth(newMonth) {
            if (currentMonth !== newMonth) {
                saveCurrentMonth();
                currentMonth = newMonth;
                loadMonth(currentMonth);
                document.getElementById('monthSelect').value = currentMonth;
            }
        }

        function saveCurrentMonth() {
            const daysInMonth = getDaysInMonth(currentMonth, 2025);
            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const productions = [];
            for (let i = 0; i < tbody.rows.length; i += 2) {
                const amRow = tbody.rows[i];
                const pmRow = tbody.rows[i + 1];
                const amValues = Array(daysInMonth).fill('');
                const pmValues = Array(daysInMonth).fill('');
                for (let d = 0; d < daysInMonth; d++) {
                    amValues[d] = amRow.cells[d + 2].querySelector('input')?.value || '';
                    pmValues[d] = pmRow.cells[d + 2].querySelector('input')?.value || '';
                }
                productions.push({ amValues, pmValues });
            }
            productionData[currentMonth] = productionData[currentMonth] || { deductions: {} };
            productionData[currentMonth].productions = productions;

            const deductions = productionData[currentMonth].deductions || {
                homeUse: Array(daysInMonth).fill(''),
                workersMilk: Array(daysInMonth).fill(''),
                calvesMilkAM: Array(daysInMonth).fill(''),
                calvesMilkPM: Array(daysInMonth).fill('')
            };
            for (let d = 0; d < daysInMonth; d++) {
                const cellIndex = d + 2;
                deductions.homeUse[d] = document.getElementById('homeUseRow')?.cells[cellIndex]?.querySelector('input')?.value || '';
                deductions.workersMilk[d] = document.getElementById('workersMilkRow')?.cells[cellIndex]?.querySelector('input')?.value || '';
                deductions.calvesMilkAM[d] = document.getElementById('calvesMilkAMRow')?.cells[cellIndex]?.querySelector('input')?.value || '';
                deductions.calvesMilkPM[d] = document.getElementById('calvesMilkPMRow')?.cells[cellIndex]?.querySelector('input')?.value || '';
            }
            productionData[currentMonth].deductions = deductions;

            localStorage.setItem('productionData', JSON.stringify(productionData));
            sanitizeProductionData();
            document.getElementById('message').textContent = 'Data saved!';
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function loadMonth(month) {
            const year = 2025;
            const daysInMonth = getDaysInMonth(month, year);

            if (!productionData[month]) {
                productionData[month] = {
                    productions: fixedCows.map(() => ({
                        amValues: Array(daysInMonth).fill(''),
                        pmValues: Array(daysInMonth).fill('')
                    })),
                    deductions: {
                        homeUse: Array(daysInMonth).fill(''),
                        workersMilk: Array(daysInMonth).fill(''),
                        calvesMilkAM: Array(daysInMonth).fill(''),
                        calvesMilkPM: Array(daysInMonth).fill('')
                    }
                };
            }

            while (productionData[month].productions.length < fixedCows.length) {
                productionData[month].productions.push({
                    amValues: Array(daysInMonth).fill(''),
                    pmValues: Array(daysInMonth).fill('')
                });
            }
            while (productionData[month].productions.length > fixedCows.length) {
                productionData[month].productions.pop();
            }

            productionData[month].productions.forEach(prod => {
                prod.amValues = prod.amValues.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - prod.amValues.length)).fill(''));
                prod.pmValues = prod.pmValues.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - prod.pmValues.length)).fill(''));
            });
            productionData[month].deductions.homeUse = productionData[month].deductions.homeUse?.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - (productionData[month].deductions.homeUse?.length || 0))).fill('')) || Array(daysInMonth).fill('');
            productionData[month].deductions.workersMilk = productionData[month].deductions.workersMilk?.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - (productionData[month].deductions.workersMilk?.length || 0))).fill('')) || Array(daysInMonth).fill('');
            productionData[month].deductions.calvesMilkAM = productionData[month].deductions.calvesMilkAM?.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - (productionData[month].deductions.calvesMilkAM?.length || 0))).fill('')) || Array(daysInMonth).fill('');
            productionData[month].deductions.calvesMilkPM = productionData[month].deductions.calvesMilkPM?.slice(0, daysInMonth).concat(Array(Math.max(0, daysInMonth - (productionData[month].deductions.calvesMilkPM?.length || 0))).fill('')) || Array(daysInMonth).fill('');

            const thead = document.getElementById('milkTable').getElementsByTagName('thead')[0];
            const headerRow = thead.rows[0];
            headerRow.innerHTML = '';
            headerRow.insertCell().textContent = 'Cow ID/Name';
            headerRow.insertCell().textContent = 'Time';
            for (let d = 1; d <= daysInMonth; d++) {
                headerRow.insertCell().textContent = d;
            }
            headerRow.insertCell().textContent = 'DAILY TOTAL';
            headerRow.insertCell().textContent = 'MONTHLY TOTAL';
            headerRow.insertCell().textContent = 'CALVING DATE';
            headerRow.insertCell().textContent = 'DAYS SINCE';
            headerRow.insertCell().textContent = 'PREG MONTHS';

            const footerRowAM = document.getElementById('footerRowAM');
            footerRowAM.innerHTML = '';
            footerRowAM.insertCell();
            footerRowAM.insertCell().textContent = 'AM';
            for (let d = 0; d < daysInMonth; d++) {
                footerRowAM.insertCell();
            }
            footerRowAM.insertCell();
            footerRowAM.insertCell();
            footerRowAM.insertCell();
            footerRowAM.insertCell();
            footerRowAM.insertCell();

            const footerRowPM = document.getElementById('footerRowPM');
            footerRowPM.innerHTML = '';
            footerRowPM.insertCell();
            footerRowPM.insertCell().textContent = 'PM';
            for (let d = 0; d < daysInMonth; d++) {
                footerRowPM.insertCell();
            }
            footerRowPM.insertCell();
            footerRowPM.insertCell();
            footerRowPM.insertCell();
            footerRowPM.insertCell();
            footerRowPM.insertCell();

            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            const productions = productionData[month].productions;
            fixedCows.forEach((cow, index) => {
                const cowProduction = productions[index] || { amValues: Array(daysInMonth).fill(''), pmValues: Array(daysInMonth).fill('') };
                addCowToTable(cow, cowProduction.amValues, cowProduction.pmValues, daysInMonth, index);
            });

            removeDeductionsRows();
            addDeductionsRows(productionData[month].deductions, daysInMonth);

            document.getElementById('tableCaption').textContent = `${month} Records`;

            recalculate(daysInMonth);
            localStorage.setItem('productionData', JSON.stringify(productionData));
        }

        function removeDeductionsRows() {
            ['homeUseRow', 'workersMilkRow', 'calvesMilkAMRow', 'calvesMilkPMRow', 'calvesMilkTotalRow', 'totalDeductionsRow', 'netLitersRow'].forEach(id => {
                const row = document.getElementById(id);
                if (row) row.remove();
            });
        }

        function addDeductionsRows(deductions, daysInMonth) {
            const tfoot = document.getElementById('milkTable').getElementsByTagName('tfoot')[0];

            const homeRow = tfoot.insertRow();
            homeRow.id = 'homeUseRow';
            const labelCellHome = homeRow.insertCell();
            labelCellHome.colSpan = 2;
            labelCellHome.textContent = 'Home Use';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = homeRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.homeUse[d] || '';
                input.addEventListener('focus', () => highlightDeductionRow(homeRow));
                input.addEventListener('blur', () => removeHighlight(homeRow));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            homeRow.insertCell();
            homeRow.insertCell();
            homeRow.insertCell();
            homeRow.insertCell();
            homeRow.insertCell();

            const workersRow = tfoot.insertRow();
            workersRow.id = 'workersMilkRow';
            const labelCellWorkers = workersRow.insertCell();
            labelCellWorkers.colSpan = 2;
            labelCellWorkers.textContent = 'Workers Milk';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = workersRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.workersMilk[d] || '';
                input.addEventListener('focus', () => highlightDeductionRow(workersRow));
                input.addEventListener('blur', () => removeHighlight(workersRow));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            workersRow.insertCell();
            workersRow.insertCell();
            workersRow.insertCell();
            workersRow.insertCell();
            workersRow.insertCell();

            const calvesAMRow = tfoot.insertRow();
            calvesAMRow.id = 'calvesMilkAMRow';
            const labelCellCalvesAM = calvesAMRow.insertCell();
            labelCellCalvesAM.colSpan = 2;
            labelCellCalvesAM.textContent = 'Calves Milk AM';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = calvesAMRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.calvesMilkAM[d] || '';
                input.addEventListener('focus', () => highlightDeductionRow(calvesAMRow));
                input.addEventListener('blur', () => removeHighlight(calvesAMRow));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            calvesAMRow.insertCell();
            calvesAMRow.insertCell();
            calvesAMRow.insertCell();
            calvesAMRow.insertCell();
            calvesAMRow.insertCell();

            const calvesPMRow = tfoot.insertRow();
            calvesPMRow.id = 'calvesMilkPMRow';
            const labelCellCalvesPM = calvesPMRow.insertCell();
            labelCellCalvesPM.colSpan = 2;
            labelCellCalvesPM.textContent = 'Calves Milk PM';
            for (let d = 0; d < daysInMonth; d++) {
                const cell = calvesPMRow.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = deductions.calvesMilkPM[d] || '';
                input.addEventListener('focus', () => highlightDeductionRow(calvesPMRow));
                input.addEventListener('blur', () => removeHighlight(calvesPMRow));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            calvesPMRow.insertCell();
            calvesPMRow.insertCell();
            calvesPMRow.insertCell();
            calvesPMRow.insertCell();
            calvesPMRow.insertCell();

            const calvesTotalRow = tfoot.insertRow();
            calvesTotalRow.id = 'calvesMilkTotalRow';
            const labelCellCalvesTotal = calvesTotalRow.insertCell();
            labelCellCalvesTotal.colSpan = 2;
            labelCellCalvesTotal.textContent = 'Calves Milk Total';
            for (let d = 0; d < daysInMonth; d++) {
                calvesTotalRow.insertCell();
            }
            calvesTotalRow.insertCell();
            calvesTotalRow.insertCell();
            calvesTotalRow.insertCell();
            calvesTotalRow.insertCell();
            calvesTotalRow.insertCell();

            const totalDeductionsRow = tfoot.insertRow();
            totalDeductionsRow.id = 'totalDeductionsRow';
            const labelCellTotalDeductions = totalDeductionsRow.insertCell();
            labelCellTotalDeductions.colSpan = 2;
            labelCellTotalDeductions.textContent = 'Total Deductions';
            for (let d = 0; d < daysInMonth; d++) {
                totalDeductionsRow.insertCell();
            }
            totalDeductionsRow.insertCell();
            totalDeductionsRow.insertCell();
            totalDeductionsRow.insertCell();
            totalDeductionsRow.insertCell();
            totalDeductionsRow.insertCell();

            const netLitersRow = tfoot.insertRow();
            netLitersRow.id = 'netLitersRow';
            const labelCellNet = netLitersRow.insertCell();
            labelCellNet.colSpan = 2;
            labelCellNet.textContent = 'Net Liters';
            for (let d = 0; d < daysInMonth; d++) {
                netLitersRow.insertCell();
            }
            netLitersRow.insertCell();
            netLitersRow.insertCell();
            netLitersRow.insertCell();
            netLitersRow.insertCell();
            netLitersRow.insertCell();
        }

        function renumberCows() {
            fixedCows.forEach((cow, index) => {
                const namePart = cow.displayName.split('. ')[1] || cow.cowName || '';
                cow.displayName = `${index + 1}. ${namePart}`;
            });
            localStorage.setItem('fixedCows', JSON.stringify(fixedCows));
        }

        function addCowFromForm() {
            const cowNo = document.getElementById('cowNo').value.trim();
            const cowName = document.getElementById('cowName').value.trim();
            const calvingDateStr = document.getElementById('calvingDate').value;
            const monthsPreg = document.getElementById('monthsPreg').value || '';

            if (!cowNo || !cowName || !calvingDateStr) {
                alert('Please fill in all required fields (Cow No, Cow Name, Last Calving Date).');
                return;
            }

            cowCount++;
            const displayName = `${cowCount}. ${cowName}`;
            const newCow = {
                cowNo,
                displayName,
                calvingDateStr,
                monthsPreg,
                cowName
            };

            fixedCows.push(newCow);
            localStorage.setItem('fixedCows', JSON.stringify(fixedCows));

            for (const month in productionData) {
                const days = getDaysInMonth(month, 2025);
                productionData[month].productions.push({ amValues: Array(days).fill(''), pmValues: Array(days).fill('') });
            }
            sanitizeProductionData();
            loadMonth(currentMonth);

            document.getElementById('cowNo').value = '';
            document.getElementById('cowName').value = '';
            document.getElementById('calvingDate').value = '';
            document.getElementById('monthsPreg').value = '';

            document.getElementById('message').textContent = `Cow ${displayName} added!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function addCowToTable(cow, amValues, pmValues, daysInMonth, index) {
            const { displayName = '', calvingDateStr = '', monthsPreg = '' } = cow;
            const calving = calvingDateStr ? new Date(calvingDateStr) : null;
            const daysSince = calving ? Math.floor((today - calving) / (1000 * 60 * 60 * 24)) : '';

            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];

            const amRow = tableBody.insertRow();
            let cell = amRow.insertCell();
            cell.innerHTML = `
                <button onclick="editCow(${index})">Edit</button>
                <button class="delete" onclick="deleteCow(${index})">Delete</button>
                ${displayName}
            `;
            amRow.insertCell().textContent = 'AM';
            for (let d = 0; d < daysInMonth; d++) {
                cell = amRow.insertCell();
                let input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = amValues[d] || '';
                input.addEventListener('focus', () => highlightCowRow(index));
                input.addEventListener('blur', () => removeHighlightCowRow(index));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            amRow.insertCell();
            amRow.insertCell();
            amRow.insertCell();
            amRow.insertCell();
            amRow.insertCell();

            const pmRow = tableBody.insertRow();
            pmRow.insertCell().textContent = displayName;
            pmRow.insertCell().textContent = 'PM';
            for (let d = 0; d < daysInMonth; d++) {
                cell = pmRow.insertCell();
                let input = document.createElement('input');
                input.type = 'number';
                input.step = '0.5';
                input.min = '0';
                input.value = pmValues[d] || '';
                input.addEventListener('focus', () => highlightCowRow(index));
                input.addEventListener('blur', () => removeHighlightCowRow(index));
                input.addEventListener('input', () => { saveCurrentMonth(); recalculate(daysInMonth); });
                cell.appendChild(input);
            }
            pmRow.insertCell();
            pmRow.insertCell();
            pmRow.insertCell().textContent = calvingDateStr;
            pmRow.insertCell().textContent = daysSince;
            pmRow.insertCell().textContent = monthsPreg;
        }

        function highlightCowRow(cowIndex) {
            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const amRow = tbody.rows[cowIndex * 2];
            const pmRow = tbody.rows[cowIndex * 2 + 1];
            if (amRow) amRow.classList.add('highlight-row');
            if (pmRow) pmRow.classList.add('highlight-row');
        }

        function removeHighlightCowRow(cowIndex) {
            const tbody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const amRow = tbody.rows[cowIndex * 2];
            const pmRow = tbody.rows[cowIndex * 2 + 1];
            if (amRow) amRow.classList.remove('highlight-row');
            if (pmRow) pmRow.classList.remove('highlight-row');
        }

        function highlightDeductionRow(row) {
            row.classList.add('highlight-row');
        }

        function removeHighlight(row) {
            row.classList.remove('highlight-row');
        }

        function editCow(index) {
            const cow = fixedCows[index];
            document.getElementById('editCowIndex').value = index;
            document.getElementById('editCowNo').value = cow.cowNo;
            document.getElementById('editCowName').value = cow.cowName || cow.displayName.split('. ')[1] || '';
            document.getElementById('editCalvingDate').value = cow.calvingDateStr;
            document.getElementById('editMonthsPreg').value = cow.monthsPreg;
            document.getElementById('editModal').style.display = 'block';
        }

        function saveEditCow() {
            const index = parseInt(document.getElementById('editCowIndex').value);
            const cowNo = document.getElementById('editCowNo').value.trim();
            const cowName = document.getElementById('editCowName').value.trim();
            const calvingDateStr = document.getElementById('editCalvingDate').value;
            const monthsPreg = document.getElementById('editMonthsPreg').value || '';

            if (!cowNo || !cowName || !calvingDateStr) {
                alert('Please fill in all required fields (Cow No, Cow Name, Last Calving Date).');
                return;
            }

            fixedCows[index] = {
                ...fixedCows[index],
                cowNo,
                cowName,
                calvingDateStr,
                monthsPreg
            };

            renumberCows();
            localStorage.setItem('fixedCows', JSON.stringify(fixedCows));
            closeEditModal();
            loadMonth(currentMonth);
            document.getElementById('message').textContent = `Cow ${fixedCows[index].displayName} updated!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editCowForm').reset();
        }

        function deleteCow(index) {
            if (!confirm(`Are you sure you want to delete ${fixedCows[index].displayName} from ${currentMonth} records?`)) return;
            
            productionData[currentMonth].inactiveCows = productionData[currentMonth].inactiveCows || [];
            if (!productionData[currentMonth].inactiveCows.includes(index)) {
                productionData[currentMonth].inactiveCows.push(index);
            }
            localStorage.setItem('productionData', JSON.stringify(productionData));
            loadMonth(currentMonth);
            document.getElementById('message').textContent = `${fixedCows[index].displayName} deleted from ${currentMonth}!`;
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function recalculate(daysInMonth) {
            const tableBody = document.getElementById('milkTable').getElementsByTagName('tbody')[0];
            const footerRowAM = document.getElementById('footerRowAM');
            const footerRowPM = document.getElementById('footerRowPM');
            const homeRow = document.getElementById('homeUseRow');
            const workersRow = document.getElementById('workersMilkRow');
            const calvesAMRow = document.getElementById('calvesMilkAMRow');
            const calvesPMRow = document.getElementById('calvesMilkPMRow');
            const calvesTotalRow = document.getElementById('calvesMilkTotalRow');
            const totalDeductionsRow = document.getElementById('totalDeductionsRow');
            const netLitersRow = document.getElementById('netLitersRow');
            const amSums = Array(daysInMonth).fill(0);
            const pmSums = Array(daysInMonth).fill(0);
            let totalAMAll = 0;
            let totalPMAll = 0;

            const cowDailyTotals = Array(daysInMonth).fill().map(() => []);
            const cowMonthlyTotals = [];
            for (let i = 0; i < tableBody.rows.length; i += 2) {
                const amRow = tableBody.rows[i];
                const pmRow = tableBody.rows[i + 1];
                const displayName = pmRow.cells[0].textContent;

                let amSum = 0;
                let pmSum = 0;
                for (let d = 0; d < daysInMonth; d++) {
                    const val = parseFloat(amRow.cells[d + 2].querySelector('input')?.value) || 0;
                    amSum += val;
                    amSums[d] += val;
                    const pmVal = parseFloat(pmRow.cells[d + 2].querySelector('input')?.value) || 0;
                    pmSum += pmVal;
                    pmSums[d] += pmVal;
                    cowDailyTotals[d].push({ cow: displayName, total: val + pmVal });
                }
                amRow.cells[daysInMonth + 2].textContent = amSum.toFixed(1);
                pmRow.cells[daysInMonth + 2].textContent = pmSum.toFixed(1);
                pmRow.cells[daysInMonth + 3].textContent = (amSum + pmSum).toFixed(1);

                totalAMAll += amSum;
                totalPMAll += pmSum;
                cowMonthlyTotals.push({ cow: displayName, total: amSum + pmSum });
            }

            for (let d = 0; d < daysInMonth; d++) {
                footerRowAM.cells[d + 2].textContent = amSums[d].toFixed(1);
                footerRowPM.cells[d + 2].textContent = pmSums[d].toFixed(1);
            }
            footerRowAM.cells[daysInMonth + 2].textContent = totalAMAll.toFixed(1);
            footerRowPM.cells[daysInMonth + 2].textContent = totalPMAll.toFixed(1);

            let homeSum = 0;
            let workersSum = 0;
            let calvesAMSum = 0;
            let calvesPMSum = 0;
            let calvesTotalSum = 0;
            const deductionsPerDay = Array(daysInMonth).fill(0);
            let totalDeductions = 0;
            for (let d = 0; d < daysInMonth; d++) {
                const cellIndex = d + 2;
                const home = parseFloat(homeRow.cells[cellIndex]?.querySelector('input')?.value) || 0;
                const workers = parseFloat(workersRow.cells[cellIndex]?.querySelector('input')?.value) || 0;
                const calvesAM = parseFloat(calvesAMRow.cells[cellIndex]?.querySelector('input')?.value) || 0;
                const calvesPM = parseFloat(calvesPMRow.cells[cellIndex]?.querySelector('input')?.value) || 0;
                const calvesTotal = calvesAM + calvesPM;
                calvesTotalRow.cells[cellIndex].textContent = calvesTotal.toFixed(1);
                deductionsPerDay[d] = home + workers + calvesAM + calvesPM;
                totalDeductionsRow.cells[cellIndex].textContent = deductionsPerDay[d].toFixed(1);
                const net = amSums[d] + pmSums[d] - deductionsPerDay[d];
                netLitersRow.cells[cellIndex].textContent = net.toFixed(1);
                homeSum += home;
                workersSum += workers;
                calvesAMSum += calvesAM;
                calvesPMSum += calvesPM;
                calvesTotalSum += calvesTotal;
                totalDeductions += deductionsPerDay[d];
            }
            homeRow.cells[daysInMonth + 2].textContent = homeSum.toFixed(1);
            workersRow.cells[daysInMonth + 2].textContent = workersSum.toFixed(1);
            calvesAMRow.cells[daysInMonth + 2].textContent = calvesAMSum.toFixed(1);
            calvesPMRow.cells[daysInMonth + 2].textContent = calvesPMSum.toFixed(1);
            calvesTotalRow.cells[daysInMonth + 2].textContent = calvesTotalSum.toFixed(1);
            totalDeductionsRow.cells[daysInMonth + 2].textContent = totalDeductions.toFixed(1);
            const totalGross = totalAMAll + totalPMAll;
            const totalNet = totalGross - totalDeductions;
            netLitersRow.cells[daysInMonth + 2].textContent = totalNet.toFixed(1);

            updateRankings(cowDailyTotals, cowMonthlyTotals, daysInMonth);
        }

        function updateRankings(cowDailyTotals, cowMonthlyTotals, daysInMonth) {
            const topDailyTbody = document.getElementById('topDailyTable').getElementsByTagName('tbody')[0];
            const worstDailyTbody = document.getElementById('worstDailyTable').getElementsByTagName('tbody')[0];
            topDailyTbody.innerHTML = '';
            worstDailyTbody.innerHTML = '';
            for (let d = 0; d < daysInMonth; d++) {
                const sorted = cowDailyTotals[d]
                    .filter(c => c.total > 0 || cowDailyTotals[d].every(c => c.total === 0))
                    .sort((a, b) => b.total - a.total);
                const top5 = sorted.slice(0, 5);
                const worst5 = sorted.slice(-5).reverse();
                if (sorted.length > 0) {
                    const topRow = topDailyTbody.insertRow();
                    topRow.insertCell().textContent = d + 1;
                    top5.forEach(cow => topRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)})`);
                    while (topRow.cells.length < 6) topRow.insertCell().textContent = '';
                    const worstRow = worstDailyTbody.insertRow();
                    worstRow.insertCell().textContent = d + 1;
                    worst5.forEach(cow => worstRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)})`);
                    while (worstRow.cells.length < 6) worstRow.insertCell().textContent = '';
                }
            }

            const weeks = [];
            for (let start = 0; start < daysInMonth; start += 7) {
                weeks.push([start, Math.min(start + 7, daysInMonth)]);
            }
            const cowWeeklyTotals = weeks.map(() => fixedCows.map(cow => ({ cow: cow.displayName, total: 0 })));
            fixedCows.forEach((cow, i) => {
                const prod = productionData[currentMonth].productions[i] || { amValues: Array(daysInMonth).fill(''), pmValues: Array(daysInMonth).fill('') };
                weeks.forEach(([start, end], w) => {
                    let total = 0;
                    for (let d = start; d < end; d++) {
                        total += (parseFloat(prod.amValues[d]) || 0) + (parseFloat(prod.pmValues[d]) || 0);
                    }
                    cowWeeklyTotals[w][i].total = total;
                });
            });

            const topWeeklyTbody = document.getElementById('topWeeklyTable').getElementsByTagName('tbody')[0];
            const worstWeeklyTbody = document.getElementById('worstWeeklyTable').getElementsByTagName('tbody')[0];
            topWeeklyTbody.innerHTML = '';
            worstWeeklyTbody.innerHTML = '';
            weeks.forEach(([start, end], w) => {
                const sorted = cowWeeklyTotals[w]
                    .filter(c => c.total > 0 || cowWeeklyTotals[w].every(c => c.total === 0))
                    .sort((a, b) => b.total - a.total);
                const top5 = sorted.slice(0, 5);
                const worst5 = sorted.slice(-5).reverse();
                if (sorted.length > 0) {
                    const topRow = topWeeklyTbody.insertRow();
                    topRow.insertCell().textContent = `Week ${w + 1} (${start + 1}-${end})`;
                    top5.forEach(cow => topRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)})`);
                    while (topRow.cells.length < 6) topRow.insertCell().textContent = '';
                    const worstRow = worstWeeklyTbody.insertRow();
                    worstRow.insertCell().textContent = `Week ${w + 1} (${start + 1}-${end})`;
                    worst5.forEach(cow => worstRow.insertCell().textContent = `${cow.cow} (${cow.total.toFixed(1)})`);
                    while (worstRow.cells.length < 6) worstRow.insertCell().textContent = '';
                }
            });

            const sortedMonthly = cowMonthlyTotals.sort((a, b) => b.total - a.total);
            const topMonthly = sortedMonthly.slice(0, 5);
            const worstMonthly = sortedMonthly.slice(-5).reverse();
            const topMonthlyTbody = document.getElementById('topMonthlyTable').getElementsByTagName('tbody')[0];
            const worstMonthlyTbody = document.getElementById('worstMonthlyTable').getElementsByTagName('tbody')[0];
            topMonthlyTbody.innerHTML = '';
            worstMonthlyTbody.innerHTML = '';
            topMonthly.forEach((cow, i) => {
                const row = topMonthlyTbody.insertRow();
                row.insertCell().textContent = i + 1;
                row.insertCell().textContent = cow.cow;
                row.insertCell().textContent = cow.total.toFixed(1);
            });
            worstMonthly.forEach((cow, i) => {
                const row = worstMonthlyTbody.insertRow();
                row.insertCell().textContent = i + 1;
                row.insertCell().textContent = cow.cow;
                row.insertCell().textContent = cow.total.toFixed(1);
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const table = document.getElementById('milkTable');
            const rows = table.rows;

            const headerRow = rows[0];
            const headerData = [];
            for (let j = 0; j < headerRow.cells.length; j++) {
                headerData.push(`"${headerRow.cells[j].textContent.replace(/"/g, '""')}"`);
            }
            csvContent += headerData.join(",") + "\r\n";

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    let cellText = cell.textContent || cell.innerText;
                    if (cell.querySelector('input')) {
                        cellText = cell.querySelector('input').value;
                    }
                    if (j === 0 && cell.querySelectorAll('button').length > 0) {
                        cellText = cell.textContent.replace(/Edit\s*Delete\s*/, '').trim();
                    }
                    rowData.push(`"${cellText.replace(/"/g, '""')}"`);
                }
                csvContent += rowData.join(",") + "\r\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentMonth}_Records.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportLocalStorage() {
            const data = {
                fixedCows: fixedCows,
                productionData: productionData
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'dairy_data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            document.getElementById('message').textContent = 'Data exported!';
            setTimeout(() => document.getElementById('message').textContent = '', 3000);
        }

        function importLocalStorage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.fixedCows || !data.productionData) {
                        alert('Invalid data format. Please upload a valid dairy_data.json file.');
                        return;
                    }

                    fixedCows = data.fixedCows;
                    fixedCows.forEach(cow => {
                        if (!cow.cowName) {
                            cow.cowName = cow.displayName.split('. ')[1] || '';
                        }
                    });

                    productionData = {};
                    months.forEach(month => {
                        const days = getDaysInMonth(month, 2025);
                        productionData[month] = {
                            productions: fixedCows.map(() => ({
                                amValues: Array(days).fill(""),
                                pmValues: Array(days).fill("")
                            })),
                            deductions: {
                                homeUse: Array(days).fill(""),
                                workersMilk: Array(days).fill(""),
                                calvesMilkAM: Array(days).fill(""),
                                calvesMilkPM: Array(days).fill("")
                            },
                            inactiveCows: []
                        };
                    });

                    Object.keys(data.productionData).forEach(month => {
                        if (!months.includes(month)) return;
                        const days = getDaysInMonth(month, 2025);
                        const monthData = data.productionData[month];
                        productionData[month].productions = monthData.productions?.length === fixedCows.length
                            ? monthData.productions.map(prod => ({
                                amValues: prod.amValues?.slice(0, days).concat(Array(Math.max(0, days - prod.amValues?.length || 0)).fill("")) || Array(days).fill(""),
                                pmValues: prod.pmValues?.slice(0, days).concat(Array(Math.max(0, days - prod.pmValues?.length || 0)).fill("")) || Array(days).fill("")
                            }))
                            : fixedCows.map(() => ({
                                amValues: Array(days).fill(""),
                                pmValues: Array(days).fill("")
                            }));
                        productionData[month].deductions = {
                            homeUse: monthData.deductions?.homeUse?.slice(0, days).concat(Array(Math.max(0, days - (monthData.deductions?.homeUse?.length || 0))).fill("")) || Array(days).fill(""),
                            workersMilk: monthData.deductions?.workersMilk?.slice(0, days).concat(Array(Math.max(0, days - (monthData.deductions?.workersMilk?.length || 0))).fill("")) || Array(days).fill(""),
                            calvesMilkAM: monthData.deductions?.calvesMilkAM?.slice(0, days).concat(Array(Math.max(0, days - (monthData.deductions?.calvesMilkAM?.length || 0))).fill("")) || Array(days).fill(""),
                            calvesMilkPM: monthData.deductions?.calvesMilkPM?.slice(0, days).concat(Array(Math.max(0, days - (monthData.deductions?.calvesMilkPM?.length || 0))).fill("")) || Array(days).fill("")
                        };
                        productionData[month].inactiveCows = monthData.inactiveCows || [];
                    });

                    cowCount = fixedCows.length;
                    localStorage.setItem('fixedCows', JSON.stringify(fixedCows));
                    localStorage.setItem('productionData', JSON.stringify(productionData));
                    loadMonth(currentMonth);
                    document.getElementById('message').textContent = 'Data imported!';
                    setTimeout(() => document.getElementById('message').textContent = '', 3000);
                } catch (err) {
                    alert('Error importing data: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
