<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Management App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1, h2 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        canvas {
            max-width: 100%;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .top-5-table {
            background-color: #d4edda; /* Light green for top 5 */
        }
        .worst-5-table {
            background-color: #f8d7da; /* Light red for worst 5 */
        }
        .lactation-green {
            background-color: #d4edda; /* Light green for 1-7 weeks */
        }
        .lactation-yellow {
            background-color: #fff3cd; /* Light yellow for 10-30 weeks */
        }
        .lactation-red {
            background-color: #f8d7da; /* Light red for 40-52 weeks */
        }
        .deduction-table input {
            width: 80px;
            padding: 5px;
        }
        .key {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .key div {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .average-row {
            font-weight: bold;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <h1>Dairy Management App</h1>

    <div class="section">
        <h2>Manage Cows</h2>
        <div class="input-group">
            <label for="cowName">Cow Name</label>
            <input type="text" id="cowName" placeholder="e.g., 297 Mercy">
        </div>
        <div class="input-group">
            <label for="birthDate">Last Birth Date</label>
            <input type="date" id="birthDate" value="">
        </div>
        <button onclick="addCow()">Add Cow</button>
        <table id="cowListTable">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="cowListBody"></tbody>
        </table>
        <div class="key">
            <div style="background-color: #d4edda;"></div> 1-7 weeks (Green)
            <div style="background-color: #fff3cd; margin-left: 10px;"></div> 10-30 weeks (Yellow)
            <div style="background-color: #f8d7da; margin-left: 10px;"></div> 40-52 weeks (Red)
        </div>
    </div>

    <div class="section">
        <h2>Add Daily Milk Production</h2>
        <div class="input-group">
            <label for="prodCow">Cow Name</label>
            <select id="prodCow">
                <option value="">Select Cow</option>
            </select>
        </div>
        <div class="input-group">
            <label for="prodDate">Date</label>
            <input type="date" id="prodDate" value="2025-07-01">
        </div>
        <div class="input-group">
            <label for="morningLiters">Morning Liters</label>
            <input type="number" id="morningLiters" step="0.1" min="0" value="0">
        </div>
        <div class="input-group">
            <label for="eveningLiters">Evening Liters</label>
            <input type="number" id="eveningLiters" step="0.1" min="0" value="0">
        </div>
        <button onclick="addProduction()">Add Production</button>
    </div>

    <div class="section">
        <h2>Set Daily Deductions per Cow</h2>
        <div class="input-group">
            <label for="dedCow">Cow Name</label>
            <select id="dedCow">
                <option value="">Select Cow</option>
            </select>
        </div>
        <div class="input-group">
            <label for="dedDate">Date</label>
            <input type="date" id="dedDate" value="2025-07-01">
        </div>
        <div class="input-group">
            <label for="calfLiters">Liters for Calf</label>
            <input type="number" id="calfLiters" step="0.1" min="0" value="0.5">
        </div>
        <div class="input-group">
            <label for="workersLiters">Liters for Workers</label>
            <input type="number" id="workersLiters" step="0.1" min="0" value="0.5">
        </div>
        <div class="input-group">
            <label for="homeLiters">Liters for Home Use</label>
            <input type="number" id="homeLiters" step="0.1" min="0" value="1.0">
        </div>
        <button onclick="addDeduction()">Add Deduction</button>
        <table id="deductionSummaryTable">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Date</th>
                    <th>Calf Liters</th>
                    <th>Workers Liters</th>
                    <th>Home Liters</th>
                </tr>
            </thead>
            <tbody id="deductionSummaryBody"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Production Analysis</h2>
        <div class="input-group">
            <label for="period">Select Period</label>
            <select id="period" onchange="updateAnalysis()">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
            </select>
        </div>
        <button onclick="exportToCSV()">Export to CSV</button>
        <button onclick="exportData()">Export All Data</button>
        <button onclick="importData()">Import Data</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        <h3>All Cows</h3>
        <table id="allCowsTable">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Morning Liters</th>
                    <th>Evening Liters</th>
                    <th>Total Liters (Before Deductions)</th>
                    <th>Net Total Liters</th>
                </tr>
            </thead>
            <tbody id="allCowsBody"></tbody>
        </table>
        <h3>Top 5 Cows (Daily)</h3>
        <table id="topCowsTable" class="top-5-table">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Morning Liters</th>
                    <th>Evening Liters</th>
                    <th>Total Liters (Before Deductions)</th>
                    <th>Net Total Liters</th>
                </tr>
            </thead>
            <tbody id="topCowsBody"></tbody>
        </table>
        <canvas id="topCowsChart"></canvas>
        <h3>Worst 5 Cows (Daily)</h3>
        <table id="worstCowsTable" class="worst-5-table">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Morning Liters</th>
                    <th>Evening Liters</th>
                    <th>Total Liters (Before Deductions)</th>
                    <th>Net Total Liters</th>
                </tr>
            </thead>
            <tbody id="worstCowsBody"></tbody>
        </table>
        <canvas id="worstCowsChart"></canvas>
        <h3>Top 5 Cows (Weekly)</h3>
        <table id="topWeeklyCowsTable" class="top-5-table">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Morning Liters</th>
                    <th>Evening Liters</th>
                    <th>Total Liters (Before Deductions)</th>
                </tr>
            </thead>
            <tbody id="topWeeklyCowsBody"></tbody>
        </table>
        <canvas id="topWeeklyCowsChart"></canvas>
        <h3>Worst 5 Cows (Weekly)</h3>
        <table id="worstWeeklyCowsTable" class="worst-5-table">
            <thead>
                <tr>
                    <th>Cow Name</th>
                    <th>Last Birth Date</th>
                    <th>Lactation Period (Months)</th>
                    <th>Morning Liters</th>
                    <th>Evening Liters</th>
                    <th>Total Liters (Before Deductions)</th>
                </tr>
            </thead>
            <tbody id="worstWeeklyCowsBody"></tbody>
        </table>
        <canvas id="worstWeeklyCowsChart"></canvas>
    </div>

    <script>
        if (typeof Chart === 'undefined') {
            console.error('Chart.js failed to load. Please check the CDN link or internet connection.');
            alert('Failed to load Chart.js. Please check your internet connection or try again later.');
        }

        // Default data as fallback
        let defaultCows = [
            {"name":"297 Mercy","birthDate":"2024-07-14"},
            {"name":"413 Magret","birthDate":"2024-07-17"},
            {"name":"427 Cece","birthDate":"2024-09-26"},
            {"name":"425 Angel","birthDate":"2024-10-01"},
            {"name":"093 Ritah","birthDate":"2025-10-10"},
            {"name":"059 Susan","birthDate":"2024-12-06"},
            {"name":"008 Frida","birthDate":"2024-12-08"},
            {"name":"434 Shana","birthDate":"2025-04-04"},
            {"name":"083 Kathy","birthDate":"2025-03-11"},
            {"name":"402 Kellen","birthDate":"2025-03-28"},
            {"name":"098 Jackline","birthDate":"2025-04-12"},
            {"name":"421 EVA","birthDate":"2025-04-18"},
            {"name":"099 Sarah","birthDate":"2025-04-20"},
            {"name":"521 Keza","birthDate":"2025-02-23"},
            {"name":"024 Kirabo","birthDate":"2025-04-25"},
            {"name":"403 Peace","birthDate":"2025-05-10"},
            {"name":"418 Irene","birthDate":"2025-05-17"},
            {"name":"296 Joan","birthDate":"2025-05-28"},
            {"name":"511 Siima","birthDate":"2025-06-22"},
            {"name":"021 BIra","birthDate":"2025-06-24"}
        ];
        let cows = JSON.parse(localStorage.getItem('cows')) || defaultCows;
        let productionData = JSON.parse(localStorage.getItem('productionData')) || [];
        let deductionsData = JSON.parse(localStorage.getItem('deductionsData')) || [];
        const currentDate = moment('2025-07-27');
        const startDate = moment('2025-07-01');
        const daysInMonth = startDate.daysInMonth();

        // Initialize sample production data if none exists
        if (productionData.length === 0) {
            for (let i = 0; i < 215; i++) {
                const cow = cows[i % cows.length];
                const day = i % daysInMonth + 1;
                const date = startDate.clone().date(day).format('YYYY-MM-DD');
                const morningLiters = Math.random() * 6 + 2; // 2 to 8 liters
                const eveningLiters = Math.random() * 5 + 1; // 1 to 6 liters
                productionData.push({ cowId: cow.name, date, morningLiters, eveningLiters, totalLiters: morningLiters + eveningLiters });
            }
        }

        localStorage.setItem('cows', JSON.stringify(cows));
        localStorage.setItem('productionData', JSON.stringify(productionData));
        localStorage.setItem('deductionsData', JSON.stringify(deductionsData));

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Cow</option>';
            cows.forEach(cow => {
                const option = document.createElement('option');
                option.value = cow.name;
                option.textContent = cow.name;
                select.appendChild(option);
            });
        }

        function addCow() {
            const cowName = document.getElementById('cowName').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            if (!cowName || !birthDate) {
                alert('Please enter a cow name and last birth date');
                return;
            }
            if (!cows.some(cow => cow.name === cowName)) {
                cows.push({ name: cowName, birthDate });
                localStorage.setItem('cows', JSON.stringify(cows));
                updateCowList();
                populateSelect('prodCow');
                populateSelect('dedCow');
                document.getElementById('cowName').value = '';
                document.getElementById('birthDate').value = '';
            } else {
                alert('Cow name already exists');
            }
        }

        function updateCowList() {
            const tbody = document.getElementById('cowListBody');
            tbody.innerHTML = '';
            cows.forEach(cow => {
                const lactationDays = cow.birthDate ? moment(currentDate).diff(moment(cow.birthDate), 'days') : 0;
                const lactationWeeks = cow.birthDate ? Math.floor(lactationDays / 7) : 0;
                const lactationMonths = cow.birthDate ? moment(currentDate).diff(moment(cow.birthDate), 'months') : 'N/A';
                let colorClass = '';
                if (lactationWeeks >= 1 && lactationWeeks <= 7) colorClass = 'lactation-green'; // 1-7 weeks
                else if (lactationWeeks >= 10 && lactationWeeks <= 30) colorClass = 'lactation-yellow'; // 10-30 weeks
                else if (lactationWeeks >= 40 && lactationWeeks <= 52) colorClass = 'lactation-red'; // 40-52 weeks
                const row = document.createElement('tr');
                row.innerHTML = `<td>${cow.name}</td><td>${cow.birthDate || 'N/A'}</td><td class="${colorClass}">${lactationMonths}</td><td><button onclick="deleteCow('${cow.name}')">Delete</button></td>`;
                tbody.appendChild(row);
            });
        }

        function deleteCow(cowName) {
            cows = cows.filter(cow => cow.name !== cowName);
            productionData = productionData.filter(p => p.cowId !== cowName);
            deductionsData = deductionsData.filter(d => d.cowId !== cowName);
            localStorage.setItem('cows', JSON.stringify(cows));
            localStorage.setItem('productionData', JSON.stringify(productionData));
            localStorage.setItem('deductionsData', JSON.stringify(deductionsData));
            updateCowList();
            populateSelect('prodCow');
            populateSelect('dedCow');
            updateAnalysis();
        }

        function addProduction() {
            const cowId = document.getElementById('prodCow').value;
            const date = document.getElementById('prodDate').value;
            const morningLiters = parseFloat(document.getElementById('morningLiters').value) || 0;
            const eveningLiters = parseFloat(document.getElementById('eveningLiters').value) || 0;
            if (!cowId || !date || (morningLiters === 0 && eveningLiters === 0)) {
                alert('Please select a cow, date, and enter valid liters');
                return;
            }
            const existingRecord = productionData.find(p => p.cowId === cowId && p.date === date);
            if (existingRecord) {
                existingRecord.morningLiters = morningLiters;
                existingRecord.eveningLiters = eveningLiters;
                existingRecord.totalLiters = morningLiters + eveningLiters;
            } else {
                productionData.push({ cowId, date, morningLiters, eveningLiters, totalLiters: morningLiters + eveningLiters });
            }
            localStorage.setItem('productionData', JSON.stringify(productionData));
            updateAnalysis();
            document.getElementById('morningLiters').value = '0';
            document.getElementById('eveningLiters').value = '0';
            alert('Production data saved');
        }

        function addDeduction() {
            const cowId = document.getElementById('dedCow').value;
            const date = document.getElementById('dedDate').value;
            const calfLiters = parseFloat(document.getElementById('calfLiters').value) || 0;
            const workersLiters = parseFloat(document.getElementById('workersLiters').value) || 0;
            const homeLiters = parseFloat(document.getElementById('homeLiters').value) || 0;
            if (!cowId || !date || (calfLiters === 0 && workersLiters === 0 && homeLiters === 0)) {
                alert('Please select a cow, date, and enter valid deductions');
                return;
            }
            const existingDeduction = deductionsData.find(d => d.cowId === cowId && d.date === date);
            if (existingDeduction) {
                existingDeduction.calfLiters = calfLiters;
                existingDeduction.workersLiters = workersLiters;
                existingDeduction.homeLiters = homeLiters;
            } else {
                deductionsData.push({ cowId, date, calfLiters, workersLiters, homeLiters });
            }
            localStorage.setItem('deductionsData', JSON.stringify(deductionsData));
            recalculateTotals();
            updateDeductionSummary();
            updateAnalysis();
            document.getElementById('calfLiters').value = '0.5';
            document.getElementById('workersLiters').value = '0.5';
            document.getElementById('homeLiters').value = '1.0';
            alert('Deductions saved');
        }

        function getDeductions(cowId, date) {
            return deductionsData.find(d => d.cowId === cowId && d.date === date) || { calfLiters: 0, workersLiters: 0, homeLiters: 0 };
        }

        function recalculateTotals() {
            productionData.forEach(record => {
                const deduction = getDeductions(record.cowId, record.date);
                record.netTotalLiters = record.totalLiters - deduction.calfLiters - deduction.workersLiters - deduction.homeLiters;
            });
            localStorage.setItem('productionData', JSON.stringify(productionData));
        }

        function updateDeductionSummary() {
            const tbody = document.getElementById('deductionSummaryBody');
            tbody.innerHTML = '';
            deductionsData.forEach(ded => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${ded.cowId}</td><td>${ded.date}</td><td>${ded.calfLiters.toFixed(2)}</td><td>${ded.workersLiters.toFixed(2)}</td><td>${ded.homeLiters.toFixed(2)}</td>`;
                tbody.appendChild(row);
            });
        }

        function exportToCSV() {
            let csvContent = 'Cow Name,Last Birth Date,Lactation Period (Months),Date,Morning Liters,Evening Liters,Total Liters (Before Deductions),Calf Liters,Workers Liters,Home Liters,Net Total Liters\n';
            productionData.forEach(record => {
                const cow = cows.find(c => c.name === record.cowId) || { birthDate: 'N/A' };
                const lactationMonths = cow.birthDate ? moment(currentDate).diff(moment(cow.birthDate), 'months') : 'N/A';
                const deduction = getDeductions(record.cowId, record.date);
                csvContent += `${record.cowId},${cow.birthDate || 'N/A'},${lactationMonths},${record.date},${record.morningLiters.toFixed(2)},${record.eveningLiters.toFixed(2)},${record.totalLiters.toFixed(2)},${deduction.calfLiters.toFixed(2)},${deduction.workersLiters.toFixed(2)},${deduction.homeLiters.toFixed(2)},${(record.netTotalLiters || record.totalLiters).toFixed(2)}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `dairy_production_${moment().format('YYYYMMDD')}.csv`);
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportData() {
            const data = {
                cows: cows,
                productionData: productionData,
                deductionsData: deductionsData
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `dairy_data_${moment().format('YYYYMMDD')}.json`);
            link.click();
            URL.revokeObjectURL(url);
            alert('Data exported. Save the file and import it on another device if needed.');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        cows = data.cows || cows;
                        productionData = data.productionData || productionData;
                        deductionsData = data.deductionsData || deductionsData;
                        localStorage.setItem('cows', JSON.stringify(cows));
                        localStorage.setItem('productionData', JSON.stringify(productionData));
                        localStorage.setItem('deductionsData', JSON.stringify(deductionsData));
                        updateCowList();
                        populateSelect('prodCow');
                        populateSelect('dedCow');
                        updateDeductionSummary();
                        updateAnalysis();
                        alert('Data imported successfully');
                    } catch (error) {
                        alert('Invalid data file. Please use a valid JSON export from this app.');
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            }
        }

        function updateAnalysis() {
            const period = document.getElementById('period').value;
            const groupedData = groupDataByPeriod(period);

            const sortedData = Object.entries(groupedData).sort((a, b) => b[1].total - a[1].total);
            const allCows = sortedData;
            const topCows = sortedData.slice(0, 5);
            const worstCows = sortedData.slice(-5).reverse();

            // Calculate continuous average
            const totalLiters = Object.values(groupedData).reduce((sum, stats) => sum + stats.total, 0);
            const numCows = Object.keys(groupedData).length;
            const averageLiters = numCows > 0 ? totalLiters / numCows : 0;

            updateTable('allCowsBody', allCows, period, null, averageLiters);
            updateTable('topCowsBody', topCows, period, 'top-5');
            updateTable('worstCowsBody', worstCows, period, 'worst-5');

            updateChart('topCowsChart', topCows, 'Top 5 Cows (Daily)', period);
            updateChart('worstCowsChart', worstCows, 'Worst 5 Cows (Daily)', period);

            if (period === 'weekly') {
                const weeklyGrouped = groupDataByWeek();
                const weeklySorted = Object.entries(weeklyGrouped).sort((a, b) => b[1].total - a[1].total);
                const topWeeklyCows = weeklySorted.slice(0, 5);
                const worstWeeklyCows = weeklySorted.slice(-5).reverse();
                updateTable('topWeeklyCowsBody', topWeeklyCows, 'weekly', 'top-5');
                updateTable('worstWeeklyCowsBody', worstWeeklyCows, 'weekly', 'worst-5');
                updateChart('topWeeklyCowsChart', topWeeklyCows, 'Top 5 Cows (Weekly)', 'weekly');
                updateChart('worstWeeklyCowsChart', worstWeeklyCows, 'Worst 5 Cows (Weekly)', 'weekly');
            } else {
                document.getElementById('topWeeklyCowsBody').innerHTML = '';
                document.getElementById('worstWeeklyCowsBody').innerHTML = '';
                document.getElementById('topWeeklyCowsChart').style.display = 'none';
                document.getElementById('worstWeeklyCowsChart').style.display = 'none';
            }
        }

        function groupDataByPeriod(period) {
            const grouped = {};
            productionData.forEach(record => {
                const date = moment(record.date);
                let key;
                if (period === 'daily') {
                    key = date.format('YYYY-MM-DD');
                } else if (period === 'weekly') {
                    key = date.startOf('week').format('YYYY-MM-DD');
                } else {
                    key = date.startOf('month').format('YYYY-MM');
                }
                if (!grouped[record.cowId]) {
                    grouped[record.cowId] = { morning: 0, evening: 0, total: 0, netTotal: 0 };
                }
                grouped[record.cowId].morning += record.morningLiters;
                grouped[record.cowId].evening += record.eveningLiters;
                grouped[record.cowId].total += record.totalLiters;
                grouped[record.cowId].netTotal += record.netTotalLiters || record.totalLiters;
            });
            return grouped;
        }

        function groupDataByWeek() {
            const grouped = {};
            productionData.forEach(record => {
                const date = moment(record.date);
                const key = date.startOf('week').format('YYYY-MM-DD');
                if (!grouped[record.cowId]) {
                    grouped[record.cowId] = { morning: 0, evening: 0, total: 0 };
                }
                grouped[record.cowId].morning += record.morningLiters;
                grouped[record.cowId].evening += record.eveningLiters;
                grouped[record.cowId].total += record.totalLiters;
            });
            return grouped;
        }

        function updateTable(tableId, data, period, type, averageLiters) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            data.forEach(([cowId, stats]) => {
                const cow = cows.find(c => c.name === cowId) || { birthDate: 'N/A' };
                const lactationDays = cow.birthDate ? moment(currentDate).diff(moment(cow.birthDate), 'days') : 0;
                const lactationWeeks = cow.birthDate ? Math.floor(lactationDays / 7) : 0;
                const lactationMonths = cow.birthDate ? moment(currentDate).diff(moment(cow.birthDate), 'months') : 'N/A';
                let colorClass = '';
                if (lactationWeeks >= 1 && lactationWeeks <= 7) colorClass = 'lactation-green'; // 1-7 weeks
                else if (lactationWeeks >= 10 && lactationWeeks <= 30) colorClass = 'lactation-yellow'; // 10-30 weeks
                else if (lactationWeeks >= 40 && lactationWeeks <= 52) colorClass = 'lactation-red'; // 40-52 weeks
                const deduction = getDeductions(cowId, period === 'daily' ? data[0][0].date : moment().format('YYYY-MM-DD'));
                const row = document.createElement('tr');
                row.innerHTML = `<td>${cowId}</td><td>${cow.birthDate || 'N/A'}</td><td class="${colorClass}">${lactationMonths}</td><td>${stats.morning.toFixed(2)}</td><td>${stats.evening.toFixed(2)}</td><td>${stats.total.toFixed(2)}</td>${
                    period === 'daily' ? `<td>${(stats.netTotal || stats.total - deduction.calfLiters - deduction.workersLiters - deduction.homeLiters).toFixed(2)}</td>` : ''
                }`;
                tbody.appendChild(row);
            });
            if (tableId === 'allCowsBody' && averageLiters !== undefined) {
                const avgRow = document.createElement('tr');
                avgRow.className = 'average-row';
                avgRow.innerHTML = `<td colspan="5">Average</td><td>${averageLiters.toFixed(2)}</td>${
                    period === 'daily' ? `<td>-</td>` : '' // Net average not calculated for simplicity
                }`;
                tbody.appendChild(avgRow);
            }
            if (type === 'top-5') {
                tbody.parentElement.className = 'top-5-table';
            } else if (type === 'worst-5') {
                tbody.parentElement.className = 'worst-5-table';
            }
        }

        function updateChart(chartId, data, title, period) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not available. Cannot render chart.');
                return;
            }
            const ctx = document.getElementById(chartId).getContext('2d');
            const existingChart = Chart.getChart(chartId);
            if (existingChart) existingChart.destroy();
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(([cowId]) => cowId),
                    datasets: [{
                        label: period === 'weekly' ? 'Total Liters (Weekly)' : 'Total Liters (Daily)',
                        data: data.map(([, stats]) => stats.total),
                        backgroundColor: chartId.includes('top') ? 'rgba(75, 192, 192, 0.2)' : 'rgba(255, 99, 132, 0.2)',
                        borderColor: chartId.includes('top') ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Liters' } } },
                    plugins: { title: { display: true, text: title } }
                }
            });
            if (period !== 'weekly') {
                ctx.canvas.style.display = 'block';
            } else if (chartId.includes('Weekly')) {
                ctx.canvas.style.display = 'block';
            } else {
                ctx.canvas.style.display = 'none';
            }
        }

        populateSelect('prodCow', cows);
        populateSelect('dedCow', cows);
        document.getElementById('prodDate').value = moment().format('YYYY-MM-DD');
        document.getElementById('dedDate').value = moment().format('YYYY-MM-DD');
        updateCowList();
        updateDeductionSummary();
        updateAnalysis();
    </script>